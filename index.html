<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>BioHacker Training</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body style="margin:0; padding:0; background:#000 !important; color:#fff !important; font-family:-apple-system,sans-serif; min-height:100vh;">

```
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    html { background: #000 !important; }
    body { 
        background: #000 !important; 
        color: #fff !important; 
        padding: 15px; 
        padding-bottom: 120px;
    }
    
    .top-bar { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 20px; 
        padding: 10px 0; 
        border-bottom: 1px solid #333;
        background: #000;
    }
    
    .top-bar h2 { color: #fff !important; font-size: 20px; margin: 5px 0; }
    .top-bar small { color: #888; font-size: 10px; }
    
    .global-timer { 
        font-family: monospace; 
        font-size: 24px; 
        font-weight: 700; 
        color: #666; 
        background: #111; 
        padding: 8px 16px; 
        border-radius: 8px; 
        border: 1px solid #333; 
        min-width: 90px; 
        text-align: center; 
    }
    
    .global-timer.active { 
        color: #0a84ff; 
        border-color: #0a84ff; 
        animation: pulse 2s infinite; 
    }
    
    @keyframes pulse { 
        0%, 100% {box-shadow: 0 0 0 rgba(10,132,255,0);} 
        50% {box-shadow: 0 0 15px rgba(10,132,255,0.3);} 
    }

    .ex-card { 
        display: flex; 
        align-items: center; 
        background: #1c1c1e; 
        margin-bottom: 12px; 
        border-radius: 12px; 
        overflow: hidden; 
        padding-right: 15px; 
        border: 1px solid #333; 
        position: relative; 
    }
    
    .ex-img { 
        width: 85px; 
        height: 85px; 
        object-fit: cover; 
        margin-right: 15px; 
        cursor: pointer; 
    }
    
    .ex-hint { 
        position: absolute; 
        bottom: 5px; 
        left: 5px; 
        font-size: 9px; 
        background: rgba(0,0,0,0.9); 
        padding: 3px 6px; 
        border-radius: 4px; 
        color: white; 
    }
    
    .ex-name { font-weight: bold; font-size: 16px; margin-bottom: 4px; color: #fff; }
    .ex-meta { font-size: 13px; color: #888; display: flex; gap: 10px; }
    .tag-rest { color: #ffd60a; font-weight: 600; }
    
    .sticky-action { 
        position: fixed; 
        bottom: 80px; 
        left: 15px; 
        right: 15px; 
        z-index: 90; 
    }
    
    .btn-start { 
        width: 100%; 
        background: #32d74b; 
        color: #000; 
        font-weight: 900; 
        padding: 18px; 
        border-radius: 16px; 
        border: none; 
        font-size: 18px; 
        cursor: pointer; 
        text-transform: uppercase; 
    }
    
    .active-panel { 
        background: #111; 
        border: 2px solid #0a84ff; 
        padding: 20px; 
        border-radius: 16px; 
        margin-bottom: 25px; 
        display: none; 
    }
    
    .active-panel.visible { display: block; }
    
    .rest-display { 
        font-size: 48px; 
        font-family: monospace; 
        text-align: center; 
        color: #fff; 
        margin: 15px 0; 
        font-weight: bold; 
    }
    
    .rest-controls { display: flex; gap: 8px; }
    .rest-controls button { 
        background: #2c2c2e; 
        color: white; 
        border: 1px solid #555; 
        padding: 12px; 
        border-radius: 10px; 
        flex: 1; 
        font-weight: bold; 
        cursor: pointer;
        font-size: 16px;
    }

    .finish-card { 
        display: none; 
        margin-top: 30px; 
        background: #1c1c1e; 
        padding: 20px; 
        border-radius: 20px; 
        border: 1px solid #444; 
    }
    
    .finish-card.visible { display: block; }
    .finish-card h3 { color: #fff !important; margin-bottom: 15px; }
    
    label { 
        display: block; 
        font-size: 12px; 
        color: #888; 
        margin-top: 15px; 
        margin-bottom: 5px;
    }
    
    input, select { 
        width: 100%; 
        padding: 14px; 
        background: #000; 
        border: 1px solid #555; 
        color: #fff; 
        border-radius: 10px; 
        font-size: 16px;
        -webkit-appearance: none;
    }
    
    select { 
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12'%3E%3Cpath fill='%23888' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 35px;
    }
    
    .btn-save { 
        width: 100%; 
        background: #0a84ff; 
        color: white; 
        padding: 16px; 
        border: none; 
        border-radius: 12px; 
        font-weight: bold; 
        margin-top: 20px; 
        font-size: 16px; 
        cursor: pointer; 
    }
    
    .btn-save.update { background: #ff9f0a; color: black; }

    .tomorrow-box { 
        margin-top: 40px; 
        padding: 20px; 
        border-top: 1px solid #333; 
    }
    
    .tomorrow-title { 
        font-size: 12px; 
        text-transform: uppercase; 
        color: #888; 
        margin-bottom: 10px; 
    }
    
    .mini-grid { 
        display: flex; 
        gap: 10px; 
        overflow-x: auto;
    }
    
    .mini-ex { 
        flex: 0 0 60px; 
        text-align: center; 
        font-size: 10px; 
        cursor: pointer; 
    }
    
    .mini-img { 
        width: 50px; 
        height: 50px; 
        border-radius: 10px; 
        object-fit: cover; 
        margin-bottom: 5px; 
        border: 1px solid #444; 
    }

    .modal-overlay { 
        position: fixed; 
        top: 0; 
        left: 0; 
        right: 0; 
        bottom: 0; 
        background: rgba(0,0,0,0.95); 
        z-index: 200; 
        display: none; 
        align-items: center; 
        justify-content: center; 
    }
    
    .modal-content { 
        background: #1c1c1e; 
        width: 85%; 
        max-width: 400px; 
        padding: 30px; 
        border-radius: 20px; 
        border: 1px solid #555; 
        text-align: center; 
        position: relative; 
    }
    
    .modal-content h2 { color: #fff !important; margin-bottom: 10px; }
    .modal-content p { color: #ccc; font-size: 15px; line-height: 1.5; }
    
    .close-modal { 
        position: absolute; 
        top: 15px; 
        right: 20px; 
        font-size: 32px; 
        color: #888; 
        background: none; 
        border: none; 
        cursor: pointer; 
    }
    
    .btn-video { 
        display: block; 
        width: 100%; 
        background: #ff0000; 
        color: white; 
        text-decoration: none; 
        padding: 14px; 
        border-radius: 12px; 
        margin-top: 20px; 
        font-weight: bold; 
    }

    .hidden { display: none !important; }
    
    .card { 
        background: #1c1c1e; 
        padding: 20px; 
        border-radius: 16px; 
        margin-bottom: 20px; 
        border: 1px solid #333; 
    }
    
    .page h1 { color: #fff !important; margin-bottom: 20px; font-size: 24px; }
    
    .tab-bar { 
        position: fixed; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        background: rgba(28,28,30,0.95); 
        display: flex; 
        padding: 15px; 
        border-top: 1px solid #333; 
        z-index: 100; 
    }
    
    .tab-btn { 
        flex: 1; 
        background: none; 
        border: none; 
        color: #666; 
        font-weight: 700; 
        font-size: 11px; 
        cursor: pointer; 
        padding: 10px; 
    }
    
    .tab-btn.active { color: #0a84ff; }

    .btn-add-manual { 
        width: 100%; 
        background: #0a84ff; 
        color: white; 
        padding: 16px; 
        border: none; 
        border-radius: 12px; 
        font-weight: bold; 
        font-size: 16px; 
        cursor: pointer; 
        margin-bottom: 20px; 
    }
</style>

<div id="info-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal()">√ó</button>
        <h2 id="m-title">Nombre</h2>
        <p id="m-desc">Descripci√≥n...</p>
        <a id="m-video" href="#" target="_blank" class="btn-video">üì∫ Ver en YouTube</a>
    </div>
</div>

<div id="p-train" class="page">
    <div class="top-bar">
        <div>
            <small>HOY TOCA</small>
            <h2 id="today-title">Cargando...</h2>
        </div>
        <div id="global-timer-ui" class="global-timer">00:00</div>
    </div>

    <div id="panel-active" class="active-panel">
        <div style="text-align:center; font-size:11px; color:#888; text-transform:uppercase; margin-bottom:10px;">Tiempo de Descanso</div>
        <div id="rest-display" class="rest-display">0:00</div>
        <div class="rest-controls">
            <button onclick="startRest(60)">60s</button>
            <button onclick="startRest(90)">90s</button>
            <button onclick="startRest(120)">2m</button>
        </div>
    </div>

    <div id="session-content"></div>

    <div class="tomorrow-box">
        <div class="tomorrow-title">üëÄ Previsi√≥n para Ma√±ana: <span id="tmr-type" style="color:white; font-weight:bold;">...</span></div>
        <div id="tmr-icons" class="mini-grid"></div>
    </div>

    <div id="start-btn-container" class="sticky-action">
        <button class="btn-start" onclick="startWorkout()">‚ñ∂ COMENZAR SESI√ìN</button>
    </div>

    <div id="finish-section" class="finish-card">
        <h3>Datos de la Sesi√≥n</h3>
        
        <label>Tipo de Entrenamiento</label>
        <select id="inp-type">
            <option value="Torso">Torso</option>
            <option value="Pierna">Pierna</option>
            <option value="Full Body">Full Body</option>
            <option value="Aer√≥bico">Aer√≥bico</option>
            <option value="Trekking">Trekking</option>
        </select>

        <label>Peso Corporal (Kg)</label>
        <input type="number" id="inp-weight" step="0.1" placeholder="Ej: 75.5">

        <label>Sensaci√≥n (RPE)</label>
        <select id="inp-rpe">
            <option value="">¬øC√≥mo fue?</option>
            <option value="6">6 - F√°cil (Subir nivel)</option>
            <option value="7">7 - Normal</option>
            <option value="8">8 - Duro</option>
            <option value="9">9 - Muy Duro (Bajar nivel)</option>
        </select>
        
        <button id="btn-finish" class="btn-save" onclick="saveSession()">GUARDAR SESI√ìN</button>
    </div>
</div>

<div id="p-anl" class="page hidden">
    <h1>Mi Progreso</h1>
    <div class="card"><canvas id="chart" height="150"></canvas></div>
    <div class="card" id="hist-list" style="padding-bottom:50px;"></div>
</div>

<nav class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('train')">ENTRENO</button>
    <button class="tab-btn" onclick="switchTab('anl')">DATOS</button>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, updateDoc, collection, query, orderBy, limit, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD1xdMdcbHXgGAL008bdmq22SNgLVcC9jM",
        authDomain: "appweb-entrenamiento.firebaseapp.com",
        projectId: "appweb-entrenamiento",
        storageBucket: "appweb-entrenamiento.firebasestorage.app",
        messagingSenderId: "199318318696",
        appId: "1:199318318696:web:04c592f117296e375215dd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const EXERCISES = {
        pushups: { 
            name: "Flexiones", rest: 60, 
            img: "https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?q=80&w=400&auto=format&fit=crop",
            desc: "Cuerpo recto. Baja pecho al suelo. Codos 45¬∫. Sube explosivo.",
            video: "https://www.youtube.com/results?search_query=tecnica+flexiones+correcta"
        },
        squats: { 
            name: "Sentadillas", rest: 90, 
            img: "https://images.unsplash.com/photo-1574680096145-d05b474e2155?q=80&w=400&auto=format&fit=crop",
            desc: "Pies ancho hombros. Baja cadera atr√°s y abajo. Rompe paralelo. Pecho alto.",
            video: "https://www.youtube.com/results?search_query=tecnica+sentadilla+air+squat"
        },
        lunges: { 
            name: "Zancadas", rest: 60, 
            img: "https://images.unsplash.com/photo-1434608519344-49d77a699ded?q=80&w=400&auto=format&fit=crop",
            desc: "Paso largo. Rodilla trasera casi toca suelo. 90 grados ambas piernas.",
            video: "https://www.youtube.com/results?search_query=tecnica+zancadas"
        },
        plank: { 
            name: "Plancha Abd.", rest: 45, 
            img: "https://plus.unsplash.com/premium_photo-1672046218038-f86a978f85f3?q=80&w=400&auto=format&fit=crop",
            desc: "Antebrazos apoyados. Cuerpo bloqueado. Aprieta gl√∫teo y abdomen fuerte.",
            video: "https://www.youtube.com/results?search_query=tecnica+plancha+abdominal"
        },
        burpees: { 
            name: "Burpees", rest: 90, 
            img: "https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?q=80&w=400&auto=format&fit=crop", 
            desc: "Sentadilla > Suelo > Flexi√≥n > Salto. Todo fluido.",
            video: "https://www.youtube.com/results?search_query=como+hacer+burpees"
        },
        row: { 
            name: "Remo / Dominada", rest: 90, 
            img: "https://images.unsplash.com/photo-1598289431512-b97b0917affc?q=80&w=400&auto=format&fit=crop",
            desc: "Tracci√≥n vertical u horizontal. C√©ntrate en juntar esc√°pulas atr√°s.",
            video: "https://www.youtube.com/results?search_query=australian+pull+ups+home"
        }
    };

    const SCHEDULE = {
        1: { type: "Torso", keys: ["pushups", "row", "plank"] },
        2: { type: "Aer√≥bico", keys: [] },
        3: { type: "Pierna", keys: ["squats", "lunges", "plank"] },
        4: { type: "Aer√≥bico", keys: [] },
        5: { type: "Full Body", keys: ["burpees", "squats", "pushups"] },
        6: { type: "Trekking", keys: [] },
        0: { type: "Trekking", keys: [] }
    };

    let userLevel = 1; 
    let weight = 72;
    let todayRoutine = {};
    let currentReps = 10;
    let startTime = 0;
    let globalInterval = null;
    let restInterval = null;
    let editingId = null; 

    window.initApp = async () => {
        const todayIdx = new Date().getDay();
        todayRoutine = SCHEDULE[todayIdx];
        
        onSnapshot(doc(db, "userStats", "global"), (d) => {
            if(d.exists()) {
                const data = d.data();
                userLevel = data.level || 1; 
                weight = data.weight || 72;
                currentReps = userLevel === 1 ? 10 : (userLevel === 2 ? 12 : 15);
                
                const weightInput = document.getElementById('inp-weight');
                if(weightInput && !weightInput.value) {
                    weightInput.value = weight;
                }
            }
            renderSession();
            renderTomorrow(todayIdx);
        });

        onSnapshot(query(collection(db, "workouts"), orderBy("date", "desc"), limit(10)), (snap) => {
            const logs = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderHistory(logs);
            updateChart(logs);
        });
    };

    function renderSession() {
        document.getElementById('today-title').innerText = todayRoutine.type;
        
        const typeSelect = document.getElementById('inp-type');
        if(typeSelect) typeSelect.value = todayRoutine.type;

        const container = document.getElementById('session-content');
        
        if (todayRoutine.type === "Trekking" || todayRoutine.type === "Aer√≥bico") {
            document.getElementById('start-btn-container').style.display = 'block';
            container.innerHTML = `<div class="ex-card" style="padding:30px; display:block; text-align:center; border-color:#ffd60a;">
                <div style="font-size:40px; margin-bottom:10px;">${todayRoutine.type==="Trekking"?"üèîÔ∏è":"üèÉ"}</div>
                <h3 style="color:#ffd60a;">${todayRoutine.type}</h3>
                <p style="color:#888; margin-top:10px;">Hoy no hay series.<br>Disfruta del movimiento y registra al terminar.</p>
            </div>`;
        } else {
            let html = "";
            todayRoutine.keys.forEach(key => {
                const ex = EXERCISES[key];
                html += `
                    <div class="ex-card">
                        <img src="${ex.img}" class="ex-img" onclick="showInfo('${key}')">
                        <div class="ex-hint">‚ÑπÔ∏è Toca</div>
                        <div class="ex-info">
                            <div class="ex-name">${ex.name}</div>
                            <div class="ex-meta">
                                <span>3 x ${currentReps}</span>
                                <span class="tag-rest">‚è≥ ${ex.rest}s</span>
                            </div>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
            document.getElementById('start-btn-container').style.display = 'block';
        }
    }

    function renderTomorrow(todayIdx) {
        const tmrIdx = (todayIdx + 1) % 7;
        const tmrRoutine = SCHEDULE[tmrIdx];
        document.getElementById('tmr-type').innerText = tmrRoutine.type;
        
        const container = document.getElementById('tmr-icons');
        if(tmrRoutine.keys.length === 0) {
            container.innerHTML = `<span style="font-size:12px; color:#666;">D√≠a de Cardio / Descanso</span>`;
        } else {
            container.innerHTML = tmrRoutine.keys.map(k => `
                <div class="mini-ex" onclick="showInfo('${k}')">
                    <img src="${EXERCISES[k].img}" class="mini-img">
                    <div style="color:#ccc;">${EXERCISES[k].name.split(' ')[0]}</div>
                </div>
            `).join('');
        }
    }

    window.showInfo = (key) => {
        const ex = EXERCISES[key];
        if(!ex) return;
        document.getElementById('m-title').innerText = ex.name;
        document.getElementById('m-desc').innerText = ex.desc;
        document.getElementById('m-video').href = ex.video;
        document.getElementById('info-modal').style.display = 'flex';
    };
    
    window.closeModal = () => {
        document.getElementById('info-modal').style.display = 'none';
    };

    window.startWorkout = () => {
        document.getElementById('start-btn-container').style.display = 'none';
        document.getElementById('panel-active').classList.add('visible');
        document.getElementById('finish-section').classList.add('visible');
        document.getElementById('global-timer-ui').classList.add('active');

        startTime = Date.now();
        if(globalInterval) clearInterval(globalInterval);
        
        globalInterval = setInterval(() => {
            const diff = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(diff / 60);
            const s = diff % 60;
            document.getElementById('global-timer-ui').innerText = 
                `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }, 1000);
        
        setTimeout(() => {
            document.getElementById('panel-active').scrollIntoView({behavior: "smooth", block: "center"});
        }, 300);
    };

    window.startRest = (sec) => {
        if(restInterval) clearInterval(restInterval);
        let left = sec;
        const display = document.getElementById('rest-display');
        display.style.color = "#fff";
        display.innerText = `0:${left}`;
        
        restInterval = setInterval(() => {
            left--;
            const m = Math.floor(left/60); 
            const s = left%60;
            display.innerText = `${m}:${s.toString().padStart(2,'0')}`;
            
            if(left <= 0) {
                clearInterval(restInterval);
                display.innerText = "¬°VAMOS!";
                display.style.color = "#32d74b";
                if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
        }, 1000);
    };

    window.saveSession = async () => {
        const rpe = document.getElementById('inp-rpe').value;
        const w = document.getElementById('inp-weight').value;
        const type = document.getElementById('inp-type').value;

        if(!rpe || !w || !type) {
            alert("Por favor completa todos los campos.");
            return;
        }

        const btn = document.getElementById('btn-finish');
        btn.disabled = true;
        btn.innerText = "Guardando...";

        try {
            let duration = startTime > 0 ? Math.ceil((Date.now() - startTime) / 60000) : 45;

            let newLvl = userLevel;
            if(["Torso", "Pierna", "Full Body"].includes(type)) {
                if(parseInt(rpe) <= 6) newLvl++;
                else if(parseInt(rpe) >= 9 && userLevel > 1) newLvl--;
            }

            const data = {
                date: new Date().toISOString(),
                type: type,
                rpe: parseInt(rpe),
                weight: parseFloat(w),
                duration: duration,
                level: newLvl
            };

            if(editingId) {
                await updateDoc(doc(db, "workouts", editingId), data);
                alert("Entreno actualizado");
                editingId = null;
            } else {
                await addDoc(collection(db, "workouts"), data);
                await setDoc(doc(db, "userStats", "global"), { level: newLvl, weight: parseFloat(w) }, { merge: true });
                alert("¬°Sesi√≥n guardada!");
            }
            
            location.reload();
        } catch(error) {
            console.error("Error:", error);
            alert("Error al guardar");
            btn.disabled = false;
            btn.innerText = editingId ? "ACTUALIZAR" : "GUARDAR";
        }
    };

    window.showManualForm = () => {
        switchTab('train');
        editingId = null;
        document.getElementById('start-btn-container').style.display = 'none';
        document.getElementById('finish-section').classList.add('visible');
        document.getElementById('panel-active').classList.remove('visible');
        document.getElementById('inp-weight').value = weight;
        document.getElementById('inp-rpe').value = '';
        document.getElementById('inp-type').value = todayRoutine.type;
        startTime = 0;
        if(globalInterval) clearInterval(globalInterval);
        document.getElementById('global-timer-ui').innerText = '00:00';
        document.getElementById('global-timer-ui').classList.remove('active');
        document.getElementById('btn-finish').innerText = "GUARDAR SESI√ìN MANUAL";
        document.getElementById('btn-finish').classList.remove('update');
        document.getElementById('today-title').innerText = "Registro Manual";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    function renderHistory(logs) {
        const addBtn = `<button class="btn-add-manual" onclick="showManualForm()">+ A√ëADIR SESI√ìN MANUALMENTE</button>`;
        
        const list = logs.map(l => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 0; border-bottom:1px solid #333;">
                <div>
                    <b style="font-size:14px; color:white">${l.type}</b>
```