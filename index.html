<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioHacker v8 Final</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, query, orderBy, limit, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1xdMdcbHXgGAL008bdmq22SNgLVcC9jM",
            authDomain: "appweb-entrenamiento.firebaseapp.com",
            projectId: "appweb-entrenamiento",
            storageBucket: "appweb-entrenamiento.firebasestorage.app",
            messagingSenderId: "199318318696",
            appId: "1:199318318696:web:04c592f117296e375215dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- LISTA DE EJERCICIOS (B치sicos) ---
        const exercisesList = [
            { name: "Flexiones", img: "https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?auto=format&fit=crop&w=400&q=80" },
            { name: "Sentadillas", img: "https://images.unsplash.com/photo-1574680096145-d05b474e2155?auto=format&fit=crop&w=400&q=80" },
            { name: "Plancha Abd.", img: "https://images.unsplash.com/photo-1566241440091-ec10de8db2e1?auto=format&fit=crop&w=400&q=80" }
        ];

        // --- ESTILOS ---
        const styles = `
            :root { --primary: #0a84ff; --bg: #000; --card: #1c1c1e; --text: #fff; --accent: #32d74b; --warning: #ffd60a; }
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
            
            h2, h3 { margin: 0; font-weight: 700; }
            .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #2c2c2e; overflow: hidden; }
            
            /* Header Semana */
            .week-container { display: flex; justify-content: space-between; align-items: center; background: #1c1c1e; padding: 15px; border-radius: 18px; margin-bottom: 20px; border: 1px solid #3a3a3c; }
            .dot { width: 10px; height: 10px; border-radius: 50%; background: #3a3a3c; margin-left: 5px; display: inline-block; }
            .dot.active { background: var(--accent); box-shadow: 0 0 6px var(--accent); }

            /* Stats */
            .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
            .stat-box { background: #2c2c2e; padding: 15px; border-radius: 15px; text-align: center; }
            .stat-num { font-size: 24px; font-weight: 800; display: block; }
            .stat-lbl { font-size: 10px; text-transform: uppercase; color: #8e8e93; letter-spacing: 1px; }

            /* Galer칤a Ejercicios */
            .ex-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
            .ex-item { position: relative; border-radius: 10px; overflow: hidden; aspect-ratio: 1/1; }
            .ex-item img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
            .ex-name { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); font-size: 9px; padding: 4px; text-align: center; }

            /* Inputs */
            .input-group { margin-top: 10px; }
            input, select { width: 100%; padding: 14px; background: #000; border: 1px solid #3a3a3c; color: #fff; border-radius: 12px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
            .btn-save { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; }

            /* Timer */
            .timer-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
            .timer-val { font-family: 'Courier New', monospace; font-size: 28px; color: var(--primary); font-weight: bold; }
            .timer-controls button { background: #333; color: white; border: none; padding: 8px 12px; border-radius: 8px; font-size: 12px; margin-left: 5px; }

            /* Tabs */
            .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(28,28,30,0.95); backdrop-filter: blur(10px); display: flex; padding: 15px; border-top: 1px solid #333; z-index: 100; }
            .tab-btn { flex: 1; background: none; border: none; color: #666; font-size: 11px; font-weight: 700; }
            .tab-btn.active { color: var(--primary); }
            .hidden { display: none; }
        `;
        const styleSheet = document.createElement("style"); styleSheet.innerText = styles; document.head.appendChild(styleSheet);

        // --- L칍GICA ---
        let level = 1, weight = 72;
        let todayType = "Fuerza";
        let nextDayType = "Cardio";
        let timerInt, timeLeft;

        window.initApp = async () => {
            loadChecks();

            // 1. Cargar Stats
            onSnapshot(doc(db, "userStats", "global"), (d) => {
                if(d.exists()) {
                    const data = d.data();
                    level = data.level || 1; weight = data.weight || 72;
                    document.getElementById('val-lvl').innerText = level;
                    document.getElementById('val-rm').innerText = Math.round(weight * 1.33) + "kg"; // Estimaci칩n simple
                    document.getElementById('inp-weight').value = weight;
                }
            });

            // 2. Historial y Determinaci칩n del D칤a
            onSnapshot(query(collection(db, "workouts"), orderBy("date", "desc"), limit(10)), (snapshot) => {
                const logs = snapshot.docs.map(d => ({id:d.id, ...d.data()}));
                
                renderWeek(logs);
                renderHistory(logs);
                updateChart(logs);
                
                // L칩gica del D칤a y del Siguiente
                const date = new Date();
                const day = date.getDay();
                const isWeekend = (day === 0 || day === 6);

                if(isWeekend) {
                    todayType = "Trekking";
                    nextDayType = (day === 6) ? "Trekking/Descanso" : "Fuerza"; // S치bado -> Dom, Dom -> Lunes
                } else {
                    // Si el 칰ltimo entreno fue Fuerza, hoy toca Cardio
                    if(logs.length > 0 && logs[0].type === "Fuerza") {
                        todayType = "Zona 2";
                        nextDayType = "Fuerza";
                    } else {
                        todayType = "Fuerza";
                        nextDayType = "Zona 2";
                    }
                }

                // Renderizar UI basada en el tipo
                renderDailyCard();
            });
        };

        function renderDailyCard() {
            const container = document.getElementById('dynamic-card');
            document.getElementById('title-today').innerText = todayType;
            document.getElementById('title-next').innerText = "Ma침ana: " + nextDayType;

            let contentHTML = "";

            if(todayType === "Fuerza") {
                // Generar HTML de ejercicios
                let exHTML = exercisesList.map(ex => `
                    <div class="ex-item">
                        <img src="${ex.img}">
                        <div class="ex-name">${ex.name}</div>
                    </div>
                `).join('');

                contentHTML = `
                    <div class="timer-box">
                        <span>Descanso</span>
                        <span id="timer" class="timer-val">0:00</span>
                    </div>
                    <div class="timer-controls" style="text-align:right; margin-bottom:15px;">
                        <button onclick="startTimer(60)">1:00</button>
                        <button onclick="startTimer(90)">1:30</button>
                        <button onclick="startTimer(120)">2:00</button>
                    </div>
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">RUTINA HOY:</div>
                    <div class="ex-grid">${exHTML}</div>
                `;
            } else if (todayType === "Zona 2") {
                contentHTML = `
                    <div style="text-align:center; padding:20px; color:#aaa;">
                        <div style="font-size:40px; margin-bottom:10px;">游끢</div>
                        <p>Objetivo: 45 minutos constantes.</p>
                        <p style="font-size:12px; color:#666;">Debes poder mantener una conversaci칩n sin ahogarte.</p>
                    </div>
                `;
            } else { // Trekking
                const water = (weight * 0.04).toFixed(1);
                contentHTML = `
                    <div style="background:rgba(255, 214, 10, 0.1); color:#ffd60a; padding:15px; border-radius:10px; border:1px solid #ffd60a;">
                        <h3 style="margin-bottom:5px;">久썶잺 Modo Monta침a</h3>
                        <p style="margin:0; font-size:14px;">Meta Hidrataci칩n: <b>${water} Litros</b></p>
                    </div>
                `;
            }
            container.innerHTML = contentHTML;
        }

        window.saveSession = async () => {
            const w = document.getElementById('inp-weight').value;
            const rpe = document.getElementById('inp-rpe').value;
            if(!w || !rpe) return alert("Faltan datos");

            document.getElementById('btn-save').innerText = "Guardando...";
            await addDoc(collection(db, "workouts"), {
                date: new Date().toISOString(),
                type: todayType,
                weight: parseFloat(w),
                rpe: parseInt(rpe)
            });
            
            // Actualizar peso global
            await setDoc(doc(db, "userStats", "global"), { weight: parseFloat(w) }, { merge: true });
            
            alert("춰Guardado!");
            location.reload();
        };

        // --- UTILS ---
        window.startTimer = (s) => {
            clearInterval(timerInt); timeLeft = s;
            const el = document.getElementById('timer');
            timerInt = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft/60); const sc = timeLeft%60;
                el.innerText = `${m}:${sc.toString().padStart(2,'0')}`;
                if(timeLeft<=0) { clearInterval(timerInt); navigator.vibrate(200); }
            }, 1000);
        };

        function renderWeek(logs) {
            // L칩gica simple: cuenta logs de los 칰ltimos 7 d칤as
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const count = logs.filter(l => new Date(l.date) > oneWeekAgo).length;
            
            let dots = "";
            for(let i=0; i<5; i++) dots += `<span class="dot ${i<count?'active':''}"></span>`;
            document.getElementById('week-dots').innerHTML = dots;
            document.getElementById('week-txt').innerText = `${Math.min(count, 5)}/5 Sesiones`;
        }

        function renderHistory(logs) {
            document.getElementById('hist-list').innerHTML = logs.map(l => `
                <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #333; font-size:13px;">
                    <div><b style="color:white">${l.type}</b><br><span style="color:#666">${new Date(l.date).toLocaleDateString()} 췅 RPE ${l.rpe}</span></div>
                    <button onclick="delLog('${l.id}')" style="background:none; border:1px solid #ff453a; color:#ff453a; border-radius:4px;">X</button>
                </div>
            `).join('');
        }
        window.delLog = async(id) => { if(confirm("쮹orrar?")) await deleteDoc(doc(db,"workouts",id)); };

        // Checks
        window.toggleCheck = (id) => {
            const el = document.getElementById(id);
            el.classList.toggle('checked');
            const data = JSON.parse(localStorage.getItem('bioChecks') || '{}');
            const k = new Date().toLocaleDateString();
            if(!data[k]) data[k]={};
            data[k][id] = el.classList.contains('checked');
            localStorage.setItem('bioChecks', JSON.stringify(data));
        };
        function loadChecks(){
            const data = JSON.parse(localStorage.getItem('bioChecks') || '{}');
            const k = new Date().toLocaleDateString();
            if(data[k]) {
                if(data[k]['c1']) document.getElementById('c1').classList.add('checked');
                if(data[k]['c2']) document.getElementById('c2').classList.add('checked');
            }
        }

        // Gr치fica Simple
        let chartInstance;
        function updateChart(logs) {
            const ctx = document.getElementById('chart').getContext('2d');
            const data = [...logs].reverse();
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(l => new Date(l.date).getDate()),
                    datasets: [{ label:'RPE', data: data.map(l=>l.rpe), borderColor:'#0a84ff', tension:0.4, pointRadius:2 }]
                },
                options: { plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}} }
            });
        }

        window.switchTab = (t) => {
            document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
            document.getElementById('p-'+t).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        window.addEventListener('load', initApp);
    </script>
    <style>
        .checklist-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #333; }
        .cb { width: 20px; height: 20px; border: 2px solid #666; border-radius: 6px; margin-right: 12px; }
        .checked .cb { background: var(--primary); border-color: var(--primary); }
    </style>
</head>
<body>

    <div id="p-dash" class="page">
        
        <div class="week-container">
            <div>
                <div style="font-size:10px; color:#888;">ESTA SEMANA</div>
                <div id="week-txt" style="font-weight:bold;">0/5 Sesiones</div>
            </div>
            <div id="week-dots"></div>
        </div>

        <div class="grid-stats">
            <div class="stat-box">
                <span class="stat-num" id="val-lvl">-</span>
                <span class="stat-lbl">Nivel</span>
            </div>
            <div class="stat-box">
                <span class="stat-num" style="color:var(--accent)" id="val-rm">-</span>
                <span class="stat-lbl">1RM Est.</span>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:10px; padding: 0 5px;">
            <h2 id="title-today">Cargando...</h2>
            <span id="title-next" style="font-size:11px; color:#888;">Ma침ana: ...</span>
        </div>

        <div id="dynamic-card" class="card"></div>

        <div class="card" style="border-color: #333;">
            <div style="font-size:10px; color:#888; margin-bottom:5px;">REGISTRAR SESI칍N</div>
            <input type="number" id="inp-weight" placeholder="Peso corporal (kg)">
            <select id="inp-rpe">
                <option value="">Nivel de Esfuerzo (RPE)</option>
                <option value="6">6 - F치cil</option>
                <option value="7">7 - Medio</option>
                <option value="8">8 - Duro</option>
                <option value="9">9 - Extremo</option>
            </select>
            <button id="btn-save" class="btn-save" onclick="saveSession()">GUARDAR DATOS</button>
        </div>

        <div class="card" style="padding:0;">
            <div class="checklist-item" id="c1" onclick="toggleCheck('c1')"><div class="cb"></div>Creatina</div>
            <div class="checklist-item" id="c2" onclick="toggleCheck('c2')"><div class="cb"></div>+7h Sue침o</div>
        </div>
    </div>

    <div id="p-anl" class="page hidden">
        <h1>Progreso</h1>
        <div class="card">
            <canvas id="chart" height="120"></canvas>
        </div>
        <div class="card" id="hist-list"></div>
    </div>

    <nav class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('dash')">ENTRENO</button>
        <button class="tab-btn" onclick="switchTab('anl')">AN츼LISIS</button>
    </nav>

</body>
</html>
