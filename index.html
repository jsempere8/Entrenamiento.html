<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioHacker Dashboard Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, collection, query, orderBy, limit, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1xdMdcbHXgGAL008bdmq22SNgLVcC9jM",
            authDomain: "appweb-entrenamiento.firebaseapp.com",
            projectId: "appweb-entrenamiento",
            storageBucket: "appweb-entrenamiento.firebasestorage.app",
            messagingSenderId: "199318318696",
            appId: "1:199318318696:web:04c592f117296e375215dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ESTILOS PRO ---
        const styles = `
            :root { --primary: #0a84ff; --bg: #000; --card: #1c1c1e; --text: #fff; --accent: #30d158; --warning: #ffd60a; --danger: #ff453a; }
            body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 120px; }
            .card { background: var(--card); padding: 18px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #2c2c2e; position: relative; }
            
            /* Stats Grid */
            .grid-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px; }
            .stat-box { background: #2c2c2e; padding: 15px; border-radius: 15px; text-align: center; }
            .stat-value { font-size: 24px; font-weight: 800; color: var(--text); }
            .stat-label { font-size: 10px; text-transform: uppercase; color: #8e8e93; letter-spacing: 0.5px; }
            .one-rm { color: var(--accent); }

            /* Weekly Progress */
            .week-container { display: flex; justify-content: space-between; align-items: center; background: #1c1c1e; padding: 15px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #3a3a3c; }
            .week-dots { display: flex; gap: 8px; }
            .dot { width: 12px; height: 12px; border-radius: 50%; background: #3a3a3c; transition: all 0.3s ease; }
            .dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

            /* Bio Checklist */
            .checklist-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #2c2c2e; cursor: pointer; }
            .checklist-item:last-child { border-bottom: none; }
            .cb-custom { width: 22px; height: 22px; border: 2px solid #8e8e93; border-radius: 6px; margin-right: 15px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
            .checked .cb-custom { background: var(--primary); border-color: var(--primary); }
            .cb-custom::after { content: '‚úì'; color: white; font-size: 14px; display: none; }
            .checked .cb-custom::after { display: block; }
            
            /* Buttons & Inputs */
            .btn-main { width: 100%; background: var(--primary); color: #fff; border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 700; margin-top: 10px; }
            .timer-btns { display: flex; gap: 10px; margin-top: 10px; }
            .timer-btns button { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--primary); background: rgba(10, 132, 255, 0.1); color: var(--primary); font-weight: 600; }
            .exercise-gallery { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
            .ex-img { width: 100%; height: 90px; object-fit: cover; border-radius: 10px; opacity: 0.9; }
            
            /* Trekking Mode */
            .trekking-card { background: rgba(255, 214, 10, 0.15); border: 1px solid var(--warning); color: #ffd60a; padding: 20px; border-radius: 20px; margin-bottom: 15px; }

            /* Tabs */
            .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(28,28,30,0.95); backdrop-filter: blur(20px); display: flex; padding: 15px; border-top: 0.5px solid #3a3a3c; z-index: 999; }
            .tab-btn { flex: 1; background: none; border: none; color: #8e8e93; font-size: 10px; font-weight: 600; }
            .tab-btn.active { color: var(--primary); }
            .hidden { display: none; }
            select, input { width: 100%; padding: 14px; border-radius: 12px; background: #2c2c2e; color: #fff; border: 1px solid #3a3a3c; margin-top: 8px; box-sizing: border-box; font-size: 16px; }
        `;
        const styleSheet = document.createElement("style"); styleSheet.innerText = styles; document.head.appendChild(styleSheet);

        // --- L√ìGICA ---
        let level = 1, reps = 10, weight = 72;
        let suggestedType = "Fuerza";
        let timerInt, timeLeft;

        window.initApp = async () => {
            const day = new Date().getDay();
            const isWeekend = (day === 0 || day === 6);
            loadBioChecks(); // Cargar checklist local

            // 1. Sync Stats & 1RM
            onSnapshot(doc(db, "userStats", "global"), (doc) => {
                if(doc.exists()) {
                    const d = doc.data();
                    level = d.level || 1; reps = d.reps || 10; weight = d.weight || 72;
                    
                    document.getElementById('lvl-val').innerText = level;
                    document.getElementById('weight-val').innerText = weight + "kg";
                    document.getElementById('weight-input').value = weight;
                    
                    // C√°lculo 1RM (F√≥rmula Brzycki adaptada a Calistenia)
                    // Estima fuerza m√°xima te√≥rica basada en reps con peso corporal
                    const oneRM = Math.round(weight * (1 + (reps / 30)));
                    document.getElementById('rm-val').innerText = oneRM + "kg";
                }
            });

            // 2. Historial y Progreso Semanal
            onSnapshot(query(collection(db, "workouts"), orderBy("date", "desc"), limit(20)), (snapshot) => {
                const logs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                
                calculateWeeklyProgress(logs);
                renderHistory(logs);
                updateChart(logs);
                determineNextSession(logs, isWeekend);
            });
        };

        function calculateWeeklyProgress(logs) {
            // Filtrar logs de la semana actual (Lunes a Domingo)
            const now = new Date();
            const dayOfWeek = now.getDay() || 7; // Convertir Domingo 0 a 7
            const monday = new Date(now);
            monday.setDate(now.getDate() - dayOfWeek + 1);
            monday.setHours(0,0,0,0);

            const thisWeekLogs = logs.filter(l => new Date(l.date) >= monday);
            const count = thisWeekLogs.length;

            // Renderizar c√≠rculos
            let dotsHTML = '';
            for(let i=0; i<5; i++) {
                dotsHTML += `<div class="dot ${i < count ? 'active' : ''}"></div>`;
            }
            document.getElementById('week-dots').innerHTML = dotsHTML;
            document.getElementById('week-count').innerText = `${count}/5 Sesiones`;
        }

        function determineNextSession(logs, isWeekend) {
            const gallery = document.getElementById('exercise-gallery');
            const trekCard = document.getElementById('trekking-card');
            const mainUI = document.getElementById('main-training-ui');

            if (isWeekend) {
                suggestedType = "Trekking";
                mainUI.classList.add('hidden');
                trekCard.classList.remove('hidden');
                
                // Hidrataci√≥n
                const water = (weight * 0.035).toFixed(1);
                document.getElementById('trek-water').innerText = water + " L";

            } else {
                trekCard.classList.add('hidden');
                mainUI.classList.remove('hidden');
                
                if (logs.length > 0 && logs[0].type.includes("Fuerza")) {
                    suggestedType = "Zona 2 (Cardio)";
                } else {
                    suggestedType = "Fuerza";
                }
            }

            document.getElementById('today-title').innerText = suggestedType;
            
            // Render Galer√≠a
            if(suggestedType === "Fuerza") {
                gallery.innerHTML = `
                    <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExOHY5OXJmYndicGZsc281bm95bjZ6eXp6eXp6eXp6eXp6eXp6JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1n/3o7TKuylOmScgBA6wE/giphy.gif" class="ex-img">
                    <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExOHY5OXJmYndicGZsc281bm95bjZ6eXp6eXp6eXp6eXp6eXp6JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1n/3o7TKv6lS8LSFumJmE/giphy.gif" class="ex-img">
                `;
            } else if (suggestedType.includes("Zona 2")) {
                gallery.innerHTML = `<div style="grid-column:span 2; text-align:center; padding:20px; color:#8e8e93; border:1px dashed #3a3a3c; border-radius:10px;">üèÉ Objetivo: 45 min suaves.<br>Mant√©n conversaci√≥n.</div>`;
            }
        }

        // --- BIO CHECKLIST (LocalStorage) ---
        window.toggleCheck = (id) => {
            const el = document.getElementById(id);
            el.classList.toggle('checked');
            const isChecked = el.classList.contains('checked');
            
            const today = new Date().toLocaleDateString();
            const data = JSON.parse(localStorage.getItem('bioChecks') || '{}');
            if(!data[today]) data[today] = {};
            data[today][id] = isChecked;
            localStorage.setItem('bioChecks', JSON.stringify(data));
        };

        function loadBioChecks() {
            const today = new Date().toLocaleDateString();
            const data = JSON.parse(localStorage.getItem('bioChecks') || '{}');
            const todayChecks = data[today] || {};
            
            if(todayChecks['check-creat']) document.getElementById('check-creat').classList.add('checked');
            if(todayChecks['check-sleep']) document.getElementById('check-sleep').classList.add('checked');
            if(todayChecks['check-sun']) document.getElementById('check-sun').classList.add('checked');
        }

        window.saveSession = async () => {
            const rpe = document.getElementById('rpe-input').value;
            const curW = document.getElementById('weight-input').value;
            if(!rpe || !curW) return alert("Faltan datos");

            const btn = document.getElementById('btn-save');
            btn.innerText = "Sincronizando..."; btn.disabled = true;

            await addDoc(collection(db, "workouts"), {
                date: new Date().toISOString(),
                rpe: parseInt(rpe),
                weight: parseFloat(curW),
                type: suggestedType
            });

            let updateData = { weight: parseFloat(curW) };
            if(suggestedType === "Fuerza" && rpe <= 6) {
                reps++; if(reps > 15) { reps = 10; level++; }
                updateData.level = level; updateData.reps = reps;
            }
            await setDoc(doc(db, "userStats", "global"), updateData, {merge: true});
            
            alert("¬°Guardado!");
            location.reload();
        };

        // --- TOOLS ---
        window.startTimer = (s) => {
            clearInterval(timerInt); timeLeft = s;
            const display = document.getElementById('timer-display');
            timerInt = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft/60); const sec = timeLeft%60;
                display.innerText = `${m}:${sec.toString().padStart(2,'0')}`;
                if(timeLeft<=0) { clearInterval(timerInt); display.innerText="0:00"; navigator.vibrate([200,100,200]); }
            }, 1000);
        };

        window.deleteLog = async (id) => { if(confirm("¬øBorrar?")) await deleteDoc(doc(db, "workouts", id)); };
        
        window.editLog = async (id, oldRpe) => {
            const n = prompt("Nuevo RPE:", oldRpe);
            if(n) await updateDoc(doc(db, "workouts", id), { rpe: parseInt(n) });
        };

        function renderHistory(logs) {
            document.getElementById('history-cont').innerHTML = logs.map(l => `
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #2c2c2e; padding:12px 0; font-size:13px;">
                    <div><b style="color:#fff">${l.type}</b><br><span style="color:#8e8e93">${new Date(l.date).toLocaleDateString()} ¬∑ RPE ${l.rpe}</span></div>
                    <div>
                        <button onclick="editLog('${l.id}', ${l.rpe})" style="background:none; border:1px solid #3a3a3c; color:#fff; border-radius:5px; padding:4px 8px;">Editar</button>
                        <button onclick="deleteLog('${l.id}')" style="background:none; border:1px solid #ff453a; color:#ff453a; border-radius:5px; padding:4px 8px;">X</button>
                    </div>
                </div>
            `).join('');
        }

        let chartInstance = null;
        function updateChart(logs) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            const data = [...logs].reverse();
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(l => new Date(l.date).getDate()),
                    datasets: [{ label: 'RPE', data: data.map(l => l.rpe), borderColor: '#0a84ff', tension: 0.3 }]
                },
                options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display:false } }, elements: { point: { radius: 0 } } }
            });
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('page-' + tab).classList.remove('hidden');
            event.currentTarget.classList.add('active');
        };

        window.addEventListener('load', initApp);
    </script>
</head>
<body>

    <div id="page-train" class="page">
        <div class="week-container">
            <div>
                <div style="font-size:11px; color:#8e8e93; text-transform:uppercase;">Semana Actual</div>
                <div id="week-count" style="font-weight:bold; color:var(--text);">0/5 Sesiones</div>
            </div>
            <div class="week-dots" id="week-dots">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
        </div>

        <div class="grid-stats">
            <div class="stat-box">
                <div class="stat-value" id="lvl-val">-</div>
                <div class="stat-label">Nivel</div>
            </div>
            <div class="stat-box">
                <div class="stat-value one-rm" id="rm-val">-</div>
                <div class="stat-label">1RM Est.</div>
            </div>
        </div>

        <div id="trekking-card" class="trekking-card hidden">
            <h2 style="margin:0 0 10px 0;">üèîÔ∏è Modo Monta√±a</h2>
            <p style="font-size:14px; margin:0;">Hidrataci√≥n Objetivo: <b id="trek-water">--</b></p>
            <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; margin-top:10px; font-size:12px;">
                <b>ü•§ Isot√≥nico Bio:</b> 1L Agua + Lim√≥n + Sal + Miel.
            </div>
        </div>

        <div class="card" id="main-training-ui">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="today-title" style="margin:0;">Cargando...</h2>
                <div id="timer-display" style="font-family:monospace; font-size:24px; color:var(--primary);">0:00</div>
            </div>
            
            <div class="exercise-gallery" id="exercise-gallery"></div>
            
            <div class="timer-btns">
                <button onclick="startTimer(60)">1:00</button>
                <button onclick="startTimer(90)">1:30</button>
                <button onclick="startTimer(120)">2:00</button>
            </div>

            <hr style="border:0; border-top:1px solid #2c2c2e; margin:15px 0;">

            <input type="number" id="weight-input" step="0.1" placeholder="Peso corporal (kg)">
            <select id="rpe-input">
                <option value="">RPE (Esfuerzo 1-10)</option>
                <option value="6">6 - C√≥modo</option>
                <option value="7">7 - √ìptimo</option>
                <option value="8">8 - Duro</option>
                <option value="9">9 - M√°ximo</option>
            </select>
            <button id="btn-save" class="btn-main" onclick="saveSession()">REGISTRAR</button>
        </div>

        <div class="card">
            <div style="font-size:11px; color:#8e8e93; text-transform:uppercase; margin-bottom:10px;">Bio-H√°bitos Diarios</div>
            
            <div class="checklist-item" id="check-creat" onclick="toggleCheck('check-creat')">
                <div class="cb-custom"></div>
                <div>Creatina / Magnesio</div>
            </div>
            
            <div class="checklist-item" id="check-sleep" onclick="toggleCheck('check-sleep')">
                <div class="cb-custom"></div>
                <div>+7h Sue√±o Reparador</div>
            </div>
            
            <div class="checklist-item" id="check-sun" onclick="toggleCheck('check-sun')">
                <div class="cb-custom"></div>
                <div>Luz Natural / Sol</div>
            </div>
        </div>
    </div>

    <div id="page-history" class="page hidden">
        <h1 style="margin-bottom:20px;">Tu Progreso</h1>
        <div class="card">
            <canvas id="growthChart" height="100"></canvas>
        </div>
        <div class="card" id="history-cont"></div>
    </div>

    <nav class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('train')">DASHBOARD</button>
        <button class="tab-btn" onclick="switchTab('history')">AN√ÅLISIS</button>
    </nav>
</body>
</html>
