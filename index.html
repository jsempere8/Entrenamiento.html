<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioHacker AI Coach</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1xdMdcbHXgGAL008bdmq22SNgLVcC9jM",
            authDomain: "appweb-entrenamiento.firebaseapp.com",
            projectId: "appweb-entrenamiento",
            storageBucket: "appweb-entrenamiento.firebasestorage.app",
            messagingSenderId: "199318318696",
            appId: "1:199318318696:web:04c592f117296e375215dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- BASE DE DATOS DE EJERCICIOS ---
        const EXERCISES = {
            pushups: { name: "Flexiones", img: "https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?w=400&q=80" },
            squats: { name: "Sentadillas", img: "https://images.unsplash.com/photo-1574680096145-d05b474e2155?w=400&q=80" },
            lunges: { name: "Zancadas", img: "https://images.unsplash.com/photo-1434608519344-49d77a699ded?w=400&q=80" },
            plank: { name: "Plancha Abd.", img: "https://plus.unsplash.com/premium_photo-1672046218038-f86a978f85f3?w=400&q=80" },
            burpees: { name: "Burpees", img: "https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?w=400&q=80" }, // Reusando img similar
            row: { name: "Remo (o Dominada)", img: "https://images.unsplash.com/photo-1598289431512-b97b0917affc?w=400&q=80" }
        };

        // --- RUTINAS SEMANALES ---
        const SCHEDULE = {
            1: { type: "Torso", keys: ["pushups", "row", "plank"] }, // Lunes
            2: { type: "Cardio", keys: [] }, // Martes
            3: { type: "Pierna", keys: ["squats", "lunges", "plank"] }, // Mi√©rcoles
            4: { type: "Cardio", keys: [] }, // Jueves
            5: { type: "Full Body", keys: ["burpees", "squats", "pushups"] }, // Viernes
            6: { type: "Trekking", keys: [] }, // S√°bado
            0: { type: "Trekking", keys: [] }  // Domingo
        };

        // --- ESTILOS ---
        const styles = `
            :root { --primary: #0a84ff; --bg: #000; --card: #1c1c1e; --text: #fff; --accent: #32d74b; --warning: #ffd60a; }
            body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 100px; }
            
            /* UI Elements */
            .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #2c2c2e; }
            h2, h3 { margin: 0; }
            
            /* Stats */
            .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
            .stat-box { background: #2c2c2e; padding: 15px; border-radius: 15px; text-align: center; }
            .stat-val { font-size: 24px; font-weight: 800; }
            .stat-lbl { font-size: 10px; color: #888; text-transform: uppercase; }

            /* Exercise List */
            .ex-card { display: flex; align-items: center; background: #2c2c2e; margin-bottom: 10px; border-radius: 12px; overflow: hidden; padding-right: 15px; }
            .ex-img { width: 80px; height: 80px; object-fit: cover; margin-right: 15px; }
            .ex-info { flex: 1; }
            .ex-name { font-weight: bold; font-size: 15px; margin-bottom: 4px; }
            .ex-meta { font-size: 13px; color: var(--accent); }
            
            /* Inputs */
            select, input { width: 100%; padding: 14px; background: #000; border: 1px solid #333; color: white; border-radius: 10px; margin-top: 10px; font-size: 16px; box-sizing: border-box;}
            .btn-save { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 15px; }

            /* Trekking Card */
            .trek-card { background: rgba(255, 214, 10, 0.1); border: 1px solid var(--warning); color: var(--warning); padding: 20px; border-radius: 20px; text-align: center; }

            .hidden { display: none; }
            .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(28,28,30,0.95); display: flex; padding: 15px; border-top: 1px solid #333; }
            .tab-btn { flex: 1; background: none; border: none; color: #666; font-weight: 700; }
            .tab-btn.active { color: var(--primary); }
        `;
        const styleSheet = document.createElement("style"); styleSheet.innerText = styles; document.head.appendChild(styleSheet);

        // --- VARIABLES GLOBALES ---
        let userLevel = 1; // 1 = 10 reps, 2 = 12 reps, 3 = 15 reps
        let weight = 72;
        let todayRoutine = {};
        let currentReps = 10;

        window.initApp = async () => {
            // 1. Obtener d√≠a y rutina base
            const dayIdx = new Date().getDay();
            todayRoutine = SCHEDULE[dayIdx];
            
            // 2. Cargar Stats del usuario (Nivel y Peso)
            const statsRef = doc(db, "userStats", "global");
            onSnapshot(statsRef, (d) => {
                if(d.exists()) {
                    const data = d.data();
                    userLevel = data.level || 1;
                    weight = data.weight || 72;
                    
                    // L√≥gica del Coach: Definir Reps seg√∫n Nivel
                    if(userLevel === 1) currentReps = 10;
                    else if(userLevel === 2) currentReps = 12;
                    else currentReps = 15;

                    updateUI();
                }
            });

            // 3. Cargar historial
            onSnapshot(query(collection(db, "workouts"), orderBy("date", "desc"), limit(10)), (snap) => {
                const logs = snap.docs.map(d => ({id:d.id, ...d.data()}));
                renderHistory(logs);
                updateChart(logs);
            });
        };

        function updateUI() {
            // T√≠tulo
            document.getElementById('today-title').innerText = "Hoy toca: " + todayRoutine.type;
            document.getElementById('lvl-display').innerText = `Nivel ${userLevel}`;
            document.getElementById('reps-display').innerText = `${currentReps} Reps`;

            const container = document.getElementById('workout-container');
            container.innerHTML = "";

            if (todayRoutine.type === "Trekking") {
                // MODO MONTA√ëA
                container.innerHTML = `
                    <div class="trek-card">
                        <div style="font-size:40px;">üèîÔ∏è</div>
                        <h3>D√≠a de Monta√±a</h3>
                        <p>Hidrataci√≥n objetivo: <b>${(weight*0.04).toFixed(1)} Litros</b></p>
                        <div style="font-size:12px; margin-top:10px; color:rgba(255,255,255,0.7);">
                            Disfruta de la naturaleza. Sin m√©tricas hoy.
                        </div>
                    </div>
                `;
            } else if (todayRoutine.type === "Cardio") {
                // MODO CARDIO
                container.innerHTML = `
                    <div class="card" style="text-align:center;">
                        <div style="font-size:40px;">üèÉüí®</div>
                        <h3>Zona 2 Cardio</h3>
                        <p>45 - 60 Minutos</p>
                        <p style="font-size:12px; color:#888;">Mant√©n un ritmo donde puedas hablar pero te cueste un poco.</p>
                    </div>
                `;
            } else {
                // MODO FUERZA (RUTINA ESPEC√çFICA)
                let html = `<div style="margin-bottom:10px; font-size:12px; color:#888;">COACH: Haz 3 series de cada ejercicio. Descansa 60s.</div>`;
                
                todayRoutine.keys.forEach(key => {
                    const ex = EXERCISES[key];
                    html += `
                        <div class="ex-card">
                            <img src="${ex.img}" class="ex-img">
                            <div class="ex-info">
                                <div class="ex-name">${ex.name}</div>
                                <div class="ex-meta">3 Series x ${currentReps} Reps</div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
        }

        window.saveSession = async () => {
            const rpe = parseInt(document.getElementById('inp-rpe').value);
            const w = parseFloat(document.getElementById('inp-weight').value);
            
            if(!rpe || !w) return alert("Faltan datos");

            document.getElementById('btn-save').innerText = "Analizando...";

            // --- L√ìGICA DE ENTRENADOR IA ---
            // Si es sesi√≥n de fuerza y fue f√°cil (RPE <= 6), subimos nivel
            let newLevel = userLevel;
            let msg = "¬°Datos guardados!";

            if(todayRoutine.type !== "Cardio" && todayRoutine.type !== "Trekking") {
                if(rpe <= 6) {
                    newLevel++;
                    msg = "¬°Coach: Te he visto sobrado! Subimos la dificultad para la pr√≥xima.";
                } else if (rpe >= 9 && userLevel > 1) {
                    newLevel--; // Si fue RPE 9 o 10, bajamos un poco
                    msg = "¬°Coach: Vamos a bajar un poco el ritmo para recuperar.";
                }
            }

            // Guardar Entreno
            await addDoc(collection(db, "workouts"), {
                date: new Date().toISOString(),
                type: todayRoutine.type,
                rpe: rpe,
                weight: w
            });

            // Guardar Ajustes del Usuario (Nivel y Peso)
            await setDoc(doc(db, "userStats", "global"), {
                level: newLevel,
                weight: w
            }, { merge: true });

            alert(msg);
            location.reload();
        };

        // --- RENDERING AUXILIAR ---
        function renderHistory(logs) {
            document.getElementById('hist-list').innerHTML = logs.map(l => `
                <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #333; font-size:13px;">
                    <div><b>${l.type}</b><br><span style="color:#666">${new Date(l.date).toLocaleDateString()} ¬∑ RPE ${l.rpe}</span></div>
                    <button onclick="deleteLog('${l.id}')" style="color:#ff453a; background:none; border:none;">‚úï</button>
                </div>
            `).join('');
        }
        
        window.deleteLog = async(id) => { if(confirm("¬øBorrar?")) await deleteDoc(doc(db,"workouts",id)); };

        let chartInstance;
        function updateChart(logs) {
            const ctx = document.getElementById('chart').getContext('2d');
            const data = [...logs].reverse();
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(l => new Date(l.date).getDate()),
                    datasets: [{ label:'RPE', data: data.map(l=>l.rpe), borderColor:'#0a84ff', tension:0.4 }]
                },
                options: { plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}} }
            });
        }

        window.switchTab = (t) => {
            document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
            document.getElementById('p-'+t).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        window.addEventListener('load', initApp);
    </script>
</head>
<body>

    <div id="p-train" class="page">
        <div class="grid-stats">
            <div class="stat-box">
                <div class="stat-val" id="lvl-display">-</div>
                <div class="stat-lbl">Dificultad Actual</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" style="color:var(--accent)" id="reps-display">-</div>
                <div class="stat-lbl">Objetivo Reps</div>
            </div>
        </div>

        <h2 id="today-title" style="margin-bottom:15px;">Cargando Coach...</h2>

        <div id="workout-container"></div>

        <div class="card" style="border-color: #333; margin-top:20px;">
            <div style="font-size:10px; color:#888; margin-bottom:5px;">FEEDBACK AL COACH</div>
            <input type="number" id="inp-weight" step="0.1" placeholder="Peso corporal (kg)">
            <select id="inp-rpe">
                <option value="">¬øQu√© tal te ha ido? (RPE)</option>
                <option value="5">5 - Muy F√°cil (Subir nivel)</option>
                <option value="6">6 - F√°cil (Subir nivel)</option>
                <option value="7">7 - Perfecto (Mantener)</option>
                <option value="8">8 - Duro (Mantener)</option>
                <option value="9">9 - Al l√≠mite (Bajar)</option>
                <option value="10">10 - Fallo Muscular</option>
            </select>
            <button id="btn-save" class="btn-save" onclick="saveSession()">FINALIZAR SESI√ìN</button>
        </div>
    </div>

    <div id="p-anl" class="page hidden">
        <h1 style="margin-bottom:20px;">Progreso</h1>
        <div class="card"><canvas id="chart" height="120"></canvas></div>
        <div class="card" id="hist-list"></div>
    </div>

    <nav class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('train')">COACH</button>
        <button class="tab-btn" onclick="switchTab('anl')">DATOS</button>
    </nav>

</body>
</html>
