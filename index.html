<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BioHacker Dashboard Stable</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, deleteDoc,
      collection, query, orderBy, limit, onSnapshot, addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyD1xdMdcbHXgGAL008bdmq22SNgLVcC9jM",
      authDomain: "appweb-entrenamiento.firebaseapp.com",
      projectId: "appweb-entrenamiento",
      storageBucket: "appweb-entrenamiento.firebasestorage.app",
      messagingSenderId: "199318318696",
      appId: "1:199318318696:web:04c592f117296e375215dd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- ESTILOS (ORIGINAL) ---
    const styles = `
      :root { --primary: #0a84ff; --bg: #000; --card: #1c1c1e; --text: #fff; --accent: #30d158; --warning: #ffd60a; --danger: #ff453a; }
      body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 120px; }

      /* Estructura Base */
      .card { background: var(--card); padding: 18px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #2c2c2e; position: relative; }
      .section-dynamic { display: none; } /* Oculto por defecto hasta que JS decida */
      .section-dynamic.active { display: block; animation: fadeIn 0.5s; }

      /* Stats */
      .grid-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
      .stat-box { background: #2c2c2e; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #3a3a3c; }
      .stat-value { font-size: 24px; font-weight: 800; color: var(--text); }
      .stat-label { font-size: 10px; text-transform: uppercase; color: #8e8e93; }

      /* Week Dots */
      .week-container { display: flex; justify-content: space-between; align-items: center; background: #1c1c1e; padding: 15px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #3a3a3c; }
      .dot { width: 10px; height: 10px; border-radius: 50%; background: #3a3a3c; margin-right: 5px; display: inline-block; }
      .dot.active { background: var(--accent); box-shadow: 0 0 5px var(--accent); }

      /* Inputs & Botones */
      .btn-main { width: 100%; background: var(--primary); color: #fff; border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 700; margin-top: 10px; cursor: pointer; }
      input, select { width: 100%; padding: 14px; border-radius: 12px; background: #121212; color: #fff; border: 1px solid #3a3a3c; margin-top: 8px; box-sizing: border-box; font-size: 16px; }

      /* Trekking Especial */
      .trekking-mode { border: 1px solid var(--warning); background: rgba(255, 214, 10, 0.1); color: #ffd60a; }

      /* Tabs */
      .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(28,28,30,0.95); backdrop-filter: blur(20px); display: flex; padding: 15px; border-top: 0.5px solid #3a3a3c; z-index: 999; }
      .tab-btn { flex: 1; background: none; border: none; color: #8e8e93; font-size: 10px; font-weight: 600; }
      .tab-btn.active { color: var(--primary); }
      .hidden { display: none !important; }

      /* Animaci√≥n */
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

      /* Checklist */
      .checklist-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #2c2c2e; }
      .cb { width: 20px; height: 20px; border: 2px solid #8e8e93; border-radius: 5px; margin-right: 10px; }
      .checked .cb { background: var(--primary); border-color: var(--primary); }
    `;
    const styleSheet = document.createElement("style");
    styleSheet.innerText = styles;
    document.head.appendChild(styleSheet);

    // --- UTILS ---
    const $ = (id) => document.getElementById(id);

    function escapeHTML(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function todayISO() {
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off * 60000);
      return local.toISOString().slice(0, 10);
    }

    function isWeekend(d = new Date()) {
      const day = d.getDay(); // 0 dom ... 6 s√°b
      return (day === 0 || day === 6);
    }

    // --- VARIABLES (conservando tu idea de "level/reps") ---
    let uid = null;

    let level = 1;         // gamificaci√≥n simple
    let repsProg = 10;     // gamificaci√≥n simple (no reps reales)
    let bodyWeightKg = 72;

    let suggestedType = "Fuerza A";
    let timerInt, timeLeft;

    let settings = {
      hasPullupBar: false,   // futuro
      planMode: "4day",      // recomendado (4 sesiones + movilidad)
      cardioMode: "walk",    // walk/bike/stairs
      maxSessionMin: 40,
      deloadUntil: null
    };

    let flags = { completed: false, veryHard: false };

    // --- FIRESTORE PATHS (por usuario) ---
    function userDoc(...path) { return doc(db, "users", uid, ...path); }
    function userCol(...path) { return collection(db, "users", uid, ...path); }

    // --- PROGRESI√ìN (anti-estancamiento) ---
    const DEFAULT_EXERCISES = {
      // Fuerza A
      pushup:     { name:"Flexiones", family:"push", repMin:6,  repMax:15, sets:3, tempo:"2-0-1", variant:0, hardStreak:0,
                    variants:["Inclinadas (manos altas)","Normales","Pies elevados","Declinadas + pausa abajo"] },
      splitSquat: { name:"Split squat", family:"legs", repMin:8, repMax:12, sets:3, tempo:"2-0-1", variant:0, hardStreak:0,
                    variants:["Corto rango + apoyo","Normal","Pausa abajo 1‚Äì2s","B√∫lgaras (pie atr√°s elevado)"] },
      gluteBridge:{ name:"Puente gl√∫teo", family:"hinge", repMin:12, repMax:20, sets:3, tempo:"2-1-1", variant:0, hardStreak:0,
                    variants:["Bilateral","Bilateral + pausa arriba","1 pierna alternando","1 pierna + pausa arriba"] },
      plank:      { name:"Plancha (seg)", family:"core", repMin:30, repMax:60, sets:3, tempo:"hold", variant:0, hardStreak:0,
                    variants:["Rodillas","Alta (brazos extendidos)","Normal","RKC/alcance alterno"] },

      // Fuerza B
      row:        { name:"Remo (mochila/toalla)", family:"pull", repMin:8, repMax:15, sets:3, tempo:"2-1-1", variant:0, hardStreak:0,
                    variants:["Isom√©trico con toalla","Mochila (remo inclinado)","Mochila + pausa arriba","Mochila m√°s pesada / tempo lento"] },
      rdl1leg:     { name:"RDL 1 pierna", family:"hinge", repMin:8, repMax:12, sets:3, tempo:"3-0-1", variant:0, hardStreak:0,
                    variants:["Apoyo pared","Libre","Pausa abajo","Alcance largo + tempo"] },
      pike:        { name:"Pike push-up", family:"push", repMin:6, repMax:12, sets:3, tempo:"2-0-1", variant:0, hardStreak:0,
                    variants:["Inclinadas","Pike","Pike pies elevados","Negativas lentas"] },
      deadbug:     { name:"Dead bug", family:"core", repMin:8, repMax:12, sets:3, tempo:"2-0-2", variant:0, hardStreak:0,
                    variants:["B√°sico","Con pausa","Extensi√≥n completa","Hollow to deadbug"] }
    };

    function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }

    function isDeloadActive() {
      if (!settings.deloadUntil) return false;
      return todayISO() <= settings.deloadUntil;
    }

    function formatExerciseLine(ex) {
      const v = ex.variants?.[ex.variant] ?? "Variante";
      const tempo = ex.tempo ? ` ¬∑ tempo ${ex.tempo}` : "";
      return `${ex.name}: ${ex.sets}√ó${ex.repMin}‚Äì${ex.repMax} ¬∑ ${v}${tempo}`;
    }

    function routineCardio() {
      const m = Math.min(settings.maxSessionMin || 40, 40);
      const mode = settings.cardioMode || "walk";
      const label = mode === "bike" ? "bici est√°tica" : mode === "stairs" ? "escaleras suave" : "caminar r√°pido";
      return [
        `Zona 2 ${m} min (ritmo conversacional)`,
        `Modo: ${label}`,
        "Si vas cansado: 20‚Äì30 min + movilidad 5‚Äì10 min"
      ];
    }

    function routineMobility() {
      return [
        "Movilidad 15‚Äì25 min",
        "Cadera + tobillo + tor√°cica",
        "Respiraci√≥n 2‚Äì3 min + estiramientos suaves"
      ];
    }

    function routineTrekking() {
      return [
        "Trekking a ritmo c√≥modo",
        "Anota: minutos, desnivel y RPE (opcional)",
        "Hidrataci√≥n + snack sencillo"
      ];
    }

    function routineStrengthA(exMap) {
      const deload = isDeloadActive();
      const push = deepClone(exMap.pushup);
      const legs = deepClone(exMap.splitSquat);
      const hinge = deepClone(exMap.gluteBridge);
      const core = deepClone(exMap.plank);

      if (deload) { push.sets=2; legs.sets=2; hinge.sets=2; core.sets=2; }

      return [
        "Calentamiento 6 min (movilidad + 2 rondas suave)",
        `Circuito 3‚Äì4 rondas (descanso 60‚Äì90s) ‚â§40 min${deload ? " (DELOAD)" : ""}`,
        "1) " + formatExerciseLine(push),
        "2) " + formatExerciseLine(legs),
        "3) " + formatExerciseLine(hinge),
        "4) " + formatExerciseLine(core)
      ];
    }

    function routineStrengthB(exMap) {
      const deload = isDeloadActive();
      const pull = deepClone(exMap.row);
      const hinge = deepClone(exMap.rdl1leg);
      const push = deepClone(exMap.pike);
      const core = deepClone(exMap.deadbug);

      // futuro barra
      if (settings.hasPullupBar) {
        pull.name = "Tracci√≥n (barra)";
        pull.variants = ["Colgado + retracci√≥n escapular","Negativas","Dominadas asistidas","Dominadas"];
        pull.variant = Math.min(pull.variant, pull.variants.length - 1);
      }

      if (deload) { pull.sets=2; hinge.sets=2; push.sets=2; core.sets=2; }

      return [
        "Calentamiento 6 min",
        `Circuito 3‚Äì4 rondas (descanso 60‚Äì90s) ‚â§40 min${deload ? " (DELOAD)" : ""}`,
        "1) " + formatExerciseLine(pull),
        "2) " + formatExerciseLine(hinge),
        "3) " + formatExerciseLine(push),
        "4) " + formatExerciseLine(core)
      ];
    }

    function getSuggestedTypeByDay(d = new Date()) {
      if (isWeekend(d)) return "Trekking";
      const idx = d.getDay() - 1; // lun..vie => 0..4

      const pattern4 = ["Fuerza A", "Cardio Z2", "Movilidad", "Fuerza B", "Cardio Z2"];
      const pattern5 = ["Fuerza A", "Cardio Z2", "Fuerza B", "Cardio Z2", "Fuerza A"];

      const p = (settings.planMode === "5day") ? pattern5 : pattern4;
      return p[idx] || "Movilidad";
    }

    function plannedWeekCount() {
      return (settings.planMode === "5day") ? 5 : 4;
    }

    function progressExercise(ex, completed, veryHard) {
      const next = { ...ex };

      if (veryHard) {
        next.hardStreak = (next.hardStreak || 0) + 1;
        return next;
      }

      if (!completed) {
        next.hardStreak = 0;
        return next;
      }

      next.hardStreak = 0;

      const isHold = (next.family === "core" && next.tempo === "hold");
      const repStep = isHold ? 5 : 1;
      const ceiling = isHold ? 90 : 20;

      if (next.repMax < ceiling) {
        next.repMin = Math.min(next.repMin + repStep, ceiling - (next.repMax - next.repMin));
        next.repMax = Math.min(next.repMax + repStep, ceiling);
      } else {
        if (Array.isArray(next.variants) && next.variant < next.variants.length - 1) {
          next.variant += 1;
          if (isHold) { next.repMin = 30; next.repMax = 60; }
          else if (next.family === "legs") { next.repMin = 8; next.repMax = 12; }
          else { next.repMin = 6; next.repMax = 12; }
        }
      }

      return next;
    }

    async function loadExercises() {
      const ref = userDoc("progress", "exercises");
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        await setDoc(ref, DEFAULT_EXERCISES, { merge: true });
        return deepClone(DEFAULT_EXERCISES);
      }

      const data = snap.data();
      const merged = deepClone(DEFAULT_EXERCISES);
      Object.keys(merged).forEach(k => {
        if (data[k]) merged[k] = { ...merged[k], ...data[k] };
      });
      await setDoc(ref, merged, { merge: true });
      return merged;
    }

    async function saveExercises(exMap) {
      await setDoc(userDoc("progress", "exercises"), exMap, { merge: true });
    }

    // --- UI: rutina en panel weekday (MISMO LOOK) ---
    function renderRoutineBox(lines) {
      const box = $("routine-box");
      if (!box) return;
      box.innerHTML =
        `<div style="font-size:10px; color:#888; text-transform:uppercase; margin-top:12px;">RUTINA HOY</div>` +
        `<div style="font-size:13px; margin-top:8px;">` +
          `<ul style="margin:8px 0 0 18px; padding:0;">` +
            lines.map(x => `<li style="margin:6px 0;">${escapeHTML(x)}</li>`).join("") +
          `</ul>` +
        `</div>`;
    }

    function setDeloadText() {
      const el = $("deload-text");
      if (!el) return;
      el.innerText = isDeloadActive() ? `DELOAD hasta ${settings.deloadUntil}` : "";
    }

    // --- CHECKLIST flags de progreso (reuse estilo original) ---
    function setFlagsUI() {
      const c = $("f-completed");
      const h = $("f-veryhard");
      if (c) c.classList.toggle("checked", !!flags.completed);
      if (h) h.classList.toggle("checked", !!flags.veryHard);
    }

    window.toggleFlag = (key) => {
      flags[key] = !flags[key];
      setFlagsUI();
    };

    // --- BioChecks (tu l√≥gica original) ---
    function loadBioChecks() {
      const today = new Date().toLocaleDateString();
      const data = JSON.parse(localStorage.getItem('bioChecks') || '{}');
      if(data[today]) {
        if(data[today]['c1']) $('c1').classList.add('checked');
        if(data[today]['c2']) $('c2').classList.add('checked');
        if(data[today]['c3']) $('c3').classList.add('checked');
      }
    }

    window.toggleCheck = (id) => {
      const el = $(id);
      el.classList.toggle('checked');
      const data = JSON.parse(localStorage.getItem('bioChecks') || '{}');
      const today = new Date().toLocaleDateString();
      if(!data[today]) data[today] = {};
      data[today][id] = el.classList.contains('checked');
      localStorage.setItem('bioChecks', JSON.stringify(data));
    };

    // --- TIMER (tu l√≥gica original) ---
    window.startTimer = (s) => {
      clearInterval(timerInt);
      timeLeft = s;
      const display = $('timer-val');
      display.innerText = `0:00`;
      timerInt = setInterval(() => {
        timeLeft--;
        const m = Math.floor(timeLeft/60);
        const sec = timeLeft%60;
        display.innerText = `${m}:${sec.toString().padStart(2,'0')}`;
        if(timeLeft<=0) { clearInterval(timerInt); if (navigator.vibrate) navigator.vibrate(200); }
      }, 1000);
    };

    // --- Semana (adaptado: 4 o 5 puntos seg√∫n plan) ---
    function renderWeekProgress(logs) {
      const now = new Date();
      const day = now.getDay() || 7;
      const monday = new Date(now);
      monday.setDate(now.getDate() - day + 1);
      monday.setHours(0,0,0,0);

      const planned = plannedWeekCount();

      const count = logs
        .filter(l => new Date(l.date) >= monday)
        .filter(l => {
          const d = new Date(l.date);
          const wd = d.getDay();
          return wd >= 1 && wd <= 5;
        })
        .filter(l => (l.type === "Fuerza A" || l.type === "Fuerza B" || l.type === "Cardio Z2")).length;

      $('week-dots').innerHTML = Array(planned).fill(0).map((_,i) =>
        `<span class="dot ${i<count?'active':''}"></span>`
      ).join('');
      $('week-text').innerText = `${count}/${planned} Sesiones`;
    }

    // --- Historial (igual look) ---
    function renderHistory(logs) {
      $('history-list').innerHTML = logs.map(l => `
        <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #333; font-size:13px;">
          <div>
            <b>${escapeHTML(l.type || "-")}</b>
            <br>
            <span style="color:#888">
              ${new Date(l.date).toLocaleDateString()}
              ¬∑ ${l.durationMin ? (l.durationMin + " min") : "‚Äî"}
              ¬∑ ${l.rpe ? ("RPE " + l.rpe) : "‚Äî"}
              ${l.type === "Trekking" && l.elevM ? (" ¬∑ +" + l.elevM + "m") : ""}
              ${l.completed ? " ¬∑ ‚úÖ" : ""}
              ${l.veryHard ? " ¬∑ ‚ö†Ô∏è" : ""}
            </span>
          </div>
          <button onclick="deleteLog('${l.id}')" style="background:none; border:1px solid #ff453a; color:#ff453a; border-radius:5px; padding:2px 10px;">X</button>
        </div>
      `).join('');
    }

    window.deleteLog = async(id) => {
      if(!confirm("¬øBorrar?")) return;
      await deleteDoc(doc(db, "users", uid, "workouts", id));
    };

    // --- Gr√°fica (mantenemos tu est√©tica: simple RPE line) ---
    let chartInstance;
    function updateChart(logs) {
      const ctx = $('chart').getContext('2d');
      const data = [...logs].reverse();
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'line',
         {
          labels: data.map(l => new Date(l.date).toLocaleDateString()),
          datasets: [{
            label:'RPE',
             data.map(l => l.rpe || 0),
            borderColor:'#0a84ff',
            tension:0.3
          }]
        },
        options: {
          plugins: { legend: { display:false } },
          scales: { x: { display:false }, y: { display:false } }
        }
      });
    }

    // --- Ajustes (sin romper estilo, en pesta√±a an√°lisis) ---
    window.saveSettings = async () => {
      const planMode = $('input-planmode').value;
      const cardioMode = $('input-cardiomode').value;
      const hasPullupBar = $('input-pullupbar').value === "yes";

      await setDoc(userDoc("settings", "global"), {
        planMode,
        cardioMode,
        hasPullupBar,
        maxSessionMin: 40
      }, { merge: true });

      alert("Ajustes guardados");
    };

    async function ensureDefaults() {
      await setDoc(userDoc("settings", "global"), {
        hasPullupBar: false,
        planMode: "4day",
        cardioMode: "walk",
        maxSessionMin: 40,
        deloadUntil: null
      }, { merge: true });

      await setDoc(userDoc("stats", "global"), {
        level: 1,
        repsProg: 10,
        bodyWeightKg: 72
      }, { merge: true });

      await setDoc(userDoc("progress", "exercises"), DEFAULT_EXERCISES, { merge: true });
    }

    // --- Registrar sesi√≥n (con nuevas funcionalidades) ---
    window.saveSession = async () => {
      const rpeVal = parseInt($('input-rpe').value || "0", 10);
      const bw = parseFloat($('input-weight').value || "0");
      const minutes = parseInt($('input-minutes').value || "0", 10);
      const elev = parseInt($('input-elev').value || "0", 10);

      suggestedType = getSuggestedTypeByDay(new Date());

      if(!bw || bw < 30) return alert("Por favor, rellena tu Peso (kg).");
      if(!minutes || minutes < 5) return alert("Por favor, rellena Duraci√≥n (min).");
      if(minutes > 40) return alert("M√°ximo 40 min.");

      const needsRPE = !(suggestedType === "Trekking" || suggestedType === "Movilidad");
      if(needsRPE && (!rpeVal || rpeVal < 1)) return alert("Rellena RPE (entre semana).");

      const btn = $('btn-save');
      btn.innerText = "Guardando...";
      btn.disabled = true;

      const exMap = await loadExercises();

      let routine = [];
      if (suggestedType === "Fuerza A") routine = routineStrengthA(exMap);
      else if (suggestedType === "Fuerza B") routine = routineStrengthB(exMap);
      else if (suggestedType === "Cardio Z2") routine = routineCardio();
      else if (suggestedType === "Movilidad") routine = routineMobility();
      else routine = routineTrekking();

      await addDoc(userCol("workouts"), {
        date: new Date().toISOString(),
        createdAt: serverTimestamp(),

        type: suggestedType,
        rpe: needsRPE ? rpeVal : 0,
        bodyWeightKg: bw,
        durationMin: minutes,
        elevM: (suggestedType === "Trekking") ? (elev || 0) : 0,

        completed: !!flags.completed,
        veryHard: !!flags.veryHard,
        routine
      });

      // stats (mantiene tu "level / reps" y tu 1RM estimado visual)
      let updateStats = { bodyWeightKg: bw };
      if (suggestedType.includes("Fuerza") && needsRPE && flags.completed && !flags.veryHard && rpeVal <= 6) {
        repsProg++;
        if (repsProg > 15) { repsProg = 10; level++; }
        updateStats.level = level;
        updateStats.repsProg = repsProg;
      }
      await setDoc(userDoc("stats","global"), updateStats, { merge: true });

      // progresi√≥n ejercicios + deload autom√°tico
      if (suggestedType === "Fuerza A" || suggestedType === "Fuerza B") {
        const next = deepClone(exMap);
        const keysA = ["pushup","splitSquat","gluteBridge","plank"];
        const keysB = ["row","rdl1leg","pike","deadbug"];
        const keys = (suggestedType === "Fuerza A") ? keysA : keysB;

        const veryHardEffective = flags.veryHard || (needsRPE && rpeVal >= 9);

        keys.forEach(k => {
          next[k] = progressExercise(next[k], flags.completed && !veryHardEffective, veryHardEffective);
        });

        const hardStreakMax = Math.max(...keys.map(k => next[k].hardStreak || 0));
        if (hardStreakMax >= 2) {
          const d = new Date();
          d.setDate(d.getDate() + 7);
          const off = d.getTimezoneOffset();
          const local = new Date(d.getTime() - off * 60000);
          const until = local.toISOString().slice(0, 10);

          await setDoc(userDoc("settings", "global"), { deloadUntil: until }, { merge: true });
          keys.forEach(k => { next[k].hardStreak = 0; });
        }

        await saveExercises(next);
      }

      // reset flags + UI
      flags = { completed:false, veryHard:false };
      setFlagsUI();

      $('input-rpe').value = "";
      $('input-minutes').value = "";
      $('input-elev').value = "";
      // mantenemos input-weight (peso corporal) como est√°

      btn.innerText = "REGISTRAR SESI√ìN";
      btn.disabled = false;

      alert("¬°Guardado!");
    };

    // --- Tabs (corregido: pasamos event) ---
    window.switchTab = (t, ev) => {
      document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
      $('p-'+t).classList.remove('hidden');
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      if (ev?.currentTarget) ev.currentTarget.classList.add('active');
    };

    // --- LISTENERS ---
    async function initFirestoreListeners() {
      // SETTINGS
      onSnapshot(userDoc("settings","global"), async (snap) => {
        if (snap.exists()) settings = { ...settings, ...snap.data() };

        // reflejar ajustes en UI (pesta√±a an√°lisis)
        if ($('input-planmode')) $('input-planmode').value = settings.planMode || "4day";
        if ($('input-cardiomode')) $('input-cardiomode').value = settings.cardioMode || "walk";
        if ($('input-pullupbar')) $('input-pullupbar').value = settings.hasPullupBar ? "yes" : "no";

        setDeloadText();
      });

      // STATS
      onSnapshot(userDoc("stats","global"), (snap) => {
        if(!snap.exists()) return;
        const d = snap.data();

        level = d.level || 1;
        repsProg = d.repsProg || 10;
        bodyWeightKg = d.bodyWeightKg || 72;

        $('lvl-val').innerText = level;

        // mantenemos tu widget ‚Äú1RM Est.‚Äù, usando Epley sobre el peso corporal y repsProg (solo como indicador gamificado)
        const oneRM = Math.round(bodyWeightKg * (1 + (repsProg / 30)));
        $('rm-val').innerText = oneRM + "kg";

        $('input-weight').value = bodyWeightKg;
      });

      // WORKOUTS
      onSnapshot(query(userCol("workouts"), orderBy("date","desc"), limit(30)), async (snapshot) => {
        const logs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));

        renderHistory(logs);
        updateChart(logs);
        renderWeekProgress(logs);

        // Determinar contexto por d√≠a (NO por historial)
        suggestedType = getSuggestedTypeByDay(new Date());
        $('global-title').innerText = suggestedType;

        const wknd = isWeekend(new Date());
        $('panel-weekday').classList.toggle('active', !wknd);
        $('panel-weekend').classList.toggle('active', wknd);

        // inputs trekking
        $('input-elev').classList.toggle('hidden', !wknd);

        // Paneles + rutinas
        const exMap = await loadExercises();

        if (wknd) {
          const w = parseFloat($('input-weight').value) || bodyWeightKg || 72;
          $('trek-water').innerText = (w * 0.035).toFixed(1) + " L";
        } else {
          $('gym-instruction').innerText =
            suggestedType === "Cardio Z2" ? "üèÉ Objetivo: Cardio Suave (‚â§40min)" :
            suggestedType === "Fuerza A" ? "üèãÔ∏è Objetivo: Fuerza A (‚â§40min)" :
            suggestedType === "Fuerza B" ? "üèãÔ∏è Objetivo: Fuerza B (‚â§40min)" :
            "üßò Objetivo: Movilidad (15‚Äì25min)";

          let lines = [];
          if (suggestedType === "Cardio Z2") lines = routineCardio();
          else if (suggestedType === "Movilidad") lines = routineMobility();
          else if (suggestedType === "Fuerza A") lines = routineStrengthA(exMap);
          else if (suggestedType === "Fuerza B") lines = routineStrengthB(exMap);
          renderRoutineBox(lines);
        }

        // deload text
        setDeloadText();
      });
    }

    // --- INIT APP (auth an√≥nimo) ---
    window.initApp = async () => {
      loadBioChecks();
      setFlagsUI();

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          await signInAnonymously(auth);
          return;
        }
        uid = user.uid;
        await ensureDefaults();
        initFirestoreListeners();
      });
    };

    window.addEventListener('load', initApp);
  </script>
</head>

<body>
  <div id="p-dash" class="page">
    <div class="week-container">
      <div>
        <div style="font-size:10px; color:#888;">SEMANA ACTUAL</div>
        <div id="week-text" style="font-weight:bold;">0/4 Sesiones</div>
        <div id="deload-text" style="font-size:11px; color:#ffd60a; margin-top:4px;"></div>
      </div>
      <div id="week-dots"></div>
    </div>

    <div class="grid-stats">
      <div class="stat-box">
        <div class="stat-value" id="lvl-val">-</div>
        <div class="stat-label">Nivel</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" style="color:var(--accent)" id="rm-val">-</div>
        <div class="stat-label">1RM Est.</div>
      </div>
    </div>

    <h2 id="global-title" style="margin:10px 0;">Cargando...</h2>

    <div id="panel-weekend" class="card trekking-mode section-dynamic">
      <h3 style="margin:0;">üèîÔ∏è Modo Monta√±a</h3>
      <p>Hidrataci√≥n sugerida: <b id="trek-water">--</b></p>
      <div style="font-size:12px; margin-top:5px; border-top:1px solid var(--warning); padding-top:5px;">
        ü•§ <b>Isot√≥nico:</b> Agua + Lim√≥n + Sal + Miel.
      </div>
    </div>

    <div id="panel-weekday" class="card section-dynamic">
      <h3 style="margin:0;" id="gym-instruction">Entrenamiento</h3>

      <div style="display:flex; justify-content:space-between; margin-top:15px; align-items:center;">
        <span id="timer-val" style="font-size:24px; font-family:monospace; color:var(--primary);">0:00</span>
        <div style="display:flex; gap:5px;">
          <button onclick="startTimer(60)" style="background:#333; color:#fff; border:none; padding:5px 10px; border-radius:5px;">1'</button>
          <button onclick="startTimer(90)" style="background:#333; color:#fff; border:none; padding:5px 10px; border-radius:5px;">1.5'</button>
          <button onclick="startTimer(120)" style="background:#333; color:#fff; border:none; padding:5px 10px; border-radius:5px;">2'</button>
        </div>
      </div>

      <!-- NUEVO: Rutina de hoy (misma est√©tica, sin cambiar tu dise√±o) -->
      <div id="routine-box"></div>
    </div>

    <div class="card" style="border: 1px solid var(--primary);">
      <div style="font-size:10px; color:#888; text-transform:uppercase; margin-bottom:5px;">Registrar Actividad</div>

      <!-- OJO: se mantiene id input-weight (tu c√≥digo original lo usa). Aqu√≠ se interpreta como peso corporal -->
      <input type="number" id="input-weight" step="0.1" placeholder="Peso (kg)">

      <!-- NUEVO: duraci√≥n (m√°x 40) -->
      <input type="number" id="input-minutes" step="1" placeholder="Duraci√≥n (min) ‚Äî m√°x 40">

      <select id="input-rpe">
        <option value="">Nivel de Esfuerzo (RPE)</option>
        <option value="6">6 - C√≥modo</option>
        <option value="7">7 - √ìptimo</option>
        <option value="8">8 - Duro</option>
        <option value="9">9 - M√°ximo</option>
      </select>

      <!-- NUEVO: desnivel solo trekking (se oculta por JS con la clase hidden) -->
      <input type="number" id="input-elev" step="10" placeholder="Desnivel (m) (solo trekking)" class="hidden">

      <!-- NUEVO: flags progreso (mismo estilo checklist) -->
      <div class="card" style="padding:0; margin-top:12px; border:1px solid #2c2c2e; background:#1c1c1e;">
        <div class="checklist-item" id="f-completed" onclick="toggleFlag('completed')"><div class="cb"></div>Completado (dentro de rango)</div>
        <div class="checklist-item" id="f-veryhard" onclick="toggleFlag('veryHard')"><div class="cb"></div>Muy duro / fatiga</div>
      </div>

      <button id="btn-save" class="btn-main" onclick="saveSession()">REGISTRAR SESI√ìN</button>
    </div>

    <div class="card">
      <div class="checklist-item" id="c1" onclick="toggleCheck('c1')"><div class="cb"></div>Creatina</div>
      <div class="checklist-item" id="c2" onclick="toggleCheck('c2')"><div class="cb"></div>+7h Sue√±o</div>
      <div class="checklist-item" id="c3" onclick="toggleCheck('c3')"><div class="cb"></div>Sol / Naturaleza</div>
    </div>
  </div>

  <div id="p-stats" class="page hidden">
    <h1>An√°lisis</h1>
    <div class="card"><canvas id="chart" height="150"></canvas></div>

    <!-- NUEVO: Ajustes (mismo estilo, misma paleta) -->
    <div class="card">
      <div style="font-size:10px; color:#888; text-transform:uppercase; margin-bottom:5px;">Ajustes (opcional)</div>

      <select id="input-planmode">
        <option value="4day" selected>Plan recomendado (4 sesiones + movilidad)</option>
        <option value="5day">Plan intenso (5 sesiones)</option>
      </select>

      <select id="input-cardiomode">
        <option value="walk" selected>Cardio Z2: caminar r√°pido</option>
        <option value="bike">Cardio Z2: bici est√°tica</option>
        <option value="stairs">Cardio Z2: escaleras suave</option>
      </select>

      <select id="input-pullupbar">
        <option value="no" selected>Sin barra de dominadas</option>
        <option value="yes">Tengo barra de dominadas</option>
      </select>

      <button class="btn-main" onclick="saveSettings()">GUARDAR AJUSTES</button>
    </div>

    <div class="card" id="history-list"></div>
  </div>

  <nav class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('dash', event)">DASHBOARD</button>
    <button class="tab-btn" onclick="switchTab('stats', event)">AN√ÅLISIS</button>
  </nav>
</body>
</html>
