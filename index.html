<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioHacker Dashboard Stable</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, collection, query, orderBy, limit, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1xdMdcbHXgGAL008bdmq22SNgLVcC9jM",
            authDomain: "appweb-entrenamiento.firebaseapp.com",
            projectId: "appweb-entrenamiento",
            storageBucket: "appweb-entrenamiento.firebasestorage.app",
            messagingSenderId: "199318318696",
            appId: "1:199318318696:web:04c592f117296e375215dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ESTILOS ---
        const styles = `
            :root { --primary: #0a84ff; --bg: #000; --card: #1c1c1e; --text: #fff; --accent: #30d158; --warning: #ffd60a; --danger: #ff453a; }
            body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 120px; }
            
            /* Estructura Base */
            .card { background: var(--card); padding: 18px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #2c2c2e; position: relative; }
            .section-dynamic { display: none; } /* Oculto por defecto hasta que JS decida */
            .section-dynamic.active { display: block; animation: fadeIn 0.5s; }

            /* Stats */
            .grid-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
            .stat-box { background: #2c2c2e; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #3a3a3c; }
            .stat-value { font-size: 24px; font-weight: 800; color: var(--text); }
            .stat-label { font-size: 10px; text-transform: uppercase; color: #8e8e93; }
            
            /* Week Dots */
            .week-container { display: flex; justify-content: space-between; align-items: center; background: #1c1c1e; padding: 15px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #3a3a3c; }
            .dot { width: 10px; height: 10px; border-radius: 50%; background: #3a3a3c; margin-right: 5px; display: inline-block; }
            .dot.active { background: var(--accent); box-shadow: 0 0 5px var(--accent); }

            /* Inputs & Botones */
            .btn-main { width: 100%; background: var(--primary); color: #fff; border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 700; margin-top: 10px; cursor: pointer; }
            input, select { width: 100%; padding: 14px; border-radius: 12px; background: #121212; color: #fff; border: 1px solid #3a3a3c; margin-top: 8px; box-sizing: border-box; font-size: 16px; }
            
            /* Trekking Especial */
            .trekking-mode { border: 1px solid var(--warning); background: rgba(255, 214, 10, 0.1); color: #ffd60a; }

            /* Tabs */
            .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(28,28,30,0.95); backdrop-filter: blur(20px); display: flex; padding: 15px; border-top: 0.5px solid #3a3a3c; z-index: 999; }
            .tab-btn { flex: 1; background: none; border: none; color: #8e8e93; font-size: 10px; font-weight: 600; }
            .tab-btn.active { color: var(--primary); }
            .hidden { display: none !important; }

            /* Animaci√≥n */
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            
            /* Checklist */
            .checklist-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #2c2c2e; }
            .cb { width: 20px; height: 20px; border: 2px solid #8e8e93; border-radius: 5px; margin-right: 10px; }
            .checked .cb { background: var(--primary); border-color: var(--primary); }
        `;
        const styleSheet = document.createElement("style"); styleSheet.innerText = styles; document.head.appendChild(styleSheet);

        // --- VARIABLES ---
        let level = 1, reps = 10, weight = 72;
        let suggestedType = "Fuerza"; 
        let timerInt, timeLeft;

        window.initApp = async () => {
            loadBioChecks();

            // 1. Cargar Stats y 1RM
            onSnapshot(doc(db, "userStats", "global"), (docSnap) => {
                if(docSnap.exists()) {
                    const d = docSnap.data();
                    level = d.level || 1; reps = d.reps || 10; weight = d.weight || 72;
                    
                    document.getElementById('lvl-val').innerText = level;
                    document.getElementById('weight-val').innerText = weight + "kg";
                    document.getElementById('input-weight').value = weight;
                    
                    // 1RM Estimado
                    const oneRM = Math.round(weight * (1 + (reps / 30)));
                    document.getElementById('rm-val').innerText = oneRM + "kg";
                }
            });

            // 2. Cargar Historial y L√≥gica de D√≠a
            onSnapshot(query(collection(db, "workouts"), orderBy("date", "desc"), limit(20)), (snapshot) => {
                const logs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                
                // Renderizar Historial y Gr√°fica
                renderHistory(logs);
                updateChart(logs);
                renderWeekProgress(logs);

                // Determinar Contexto (Fuerza vs Trekking)
                const day = new Date().getDay();
                const isWeekend = (day === 0 || day === 6);
                
                // L√ìGICA DE VISUALIZACI√ìN
                if (isWeekend) {
                    // ES FIN DE SEMANA:
                    suggestedType = "Trekking";
                    document.getElementById('panel-weekday').classList.remove('active');
                    document.getElementById('panel-weekend').classList.add('active');
                    
                    // Calcular Agua
                    const w = parseFloat(document.getElementById('input-weight').value) || 72;
                    document.getElementById('trek-water').innerText = (w * 0.035).toFixed(1) + " L";

                } else {
                    // ES ENTRE SEMANA:
                    document.getElementById('panel-weekend').classList.remove('active');
                    document.getElementById('panel-weekday').classList.add('active');
                    
                    // Alternancia Fuerza/Cardio
                    if (logs.length > 0 && logs[0].type.includes("Fuerza")) {
                        suggestedType = "Zona 2 (Cardio)";
                        document.getElementById('gym-instruction').innerText = "üèÉ Objetivo: Cardio Suave (45min)";
                    } else {
                        suggestedType = "Fuerza";
                        document.getElementById('gym-instruction').innerText = "üèãÔ∏è Objetivo: Rutina de Fuerza";
                    }
                }
                
                // T√≠tulo Global
                document.getElementById('global-title').innerText = suggestedType;
            });
        };

        // --- FUNCIONES DEL USUARIO ---
        
        window.saveSession = async () => {
            const rpe = document.getElementById('input-rpe').value;
            const w = document.getElementById('input-weight').value;
            
            if(!rpe || !w) return alert("Por favor, rellena Peso y RPE.");

            const btn = document.getElementById('btn-save');
            btn.innerText = "Guardando..."; btn.disabled = true;

            await addDoc(collection(db, "workouts"), {
                date: new Date().toISOString(),
                rpe: parseInt(rpe),
                weight: parseFloat(w),
                type: suggestedType
            });

            // Actualizar Peso y Nivel si corresponde
            let updateData = { weight: parseFloat(w) };
            if(suggestedType === "Fuerza" && rpe <= 6) {
                reps++; if(reps > 15) { reps = 10; level++; }
                updateData.level = level; updateData.reps = reps;
            }
            await setDoc(doc(db, "userStats", "global"), updateData, {merge: true});

            alert("¬°Guardado!");
            location.reload();
        };

        // --- UTILS (Timer, Check, Delete) ---
        window.startTimer = (s) => {
            clearInterval(timerInt); timeLeft = s;
            const display = document.getElementById('timer-val');
            timerInt = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft/60); const sec = timeLeft%60;
                display.innerText = `${m}:${sec.toString().padStart(2,'0')}`;
                if(timeLeft<=0) { clearInterval(timerInt); navigator.vibrate(200); }
            }, 1000);
        };

        window.toggleCheck = (id) => {
            const el = document.getElementById(id);
            el.classList.toggle('checked');
            // Guardar en LocalStorage
            const data = JSON.parse(localStorage.getItem('bioChecks') || '{}');
            const today = new Date().toLocaleDateString();
            if(!data[today]) data[today] = {};
            data[today][id] = el.classList.contains('checked');
            localStorage.setItem('bioChecks', JSON.stringify(data));
        };

        function loadBioChecks() {
            const today = new Date().toLocaleDateString();
            const data = JSON.parse(localStorage.getItem('bioChecks') || '{}');
            if(data[today]) {
                if(data[today]['c1']) document.getElementById('c1').classList.add('checked');
                if(data[today]['c2']) document.getElementById('c2').classList.add('checked');
                if(data[today]['c3']) document.getElementById('c3').classList.add('checked');
            }
        }

        function renderWeekProgress(logs) {
            const now = new Date();
            const day = now.getDay() || 7; 
            const monday = new Date(now); monday.setDate(now.getDate() - day + 1); monday.setHours(0,0,0,0);
            
            const count = logs.filter(l => new Date(l.date) >= monday).length;
            document.getElementById('week-dots').innerHTML = Array(5).fill(0).map((_,i) => 
                `<span class="dot ${i<count?'active':''}"></span>`
            ).join('');
            document.getElementById('week-text').innerText = `${count}/5 Sesiones`;
        }

        function renderHistory(logs) {
            document.getElementById('history-list').innerHTML = logs.map(l => `
                <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #333; font-size:13px;">
                    <div><b>${l.type}</b><br><span style="color:#888">${new Date(l.date).toLocaleDateString()} ¬∑ RPE ${l.rpe}</span></div>
                    <button onclick="deleteLog('${l.id}')" style="background:none; border:1px solid #ff453a; color:#ff453a; border-radius:5px;">X</button>
                </div>
            `).join('');
        }
        
        window.deleteLog = async(id) => { if(confirm("¬øBorrar?")) await deleteDoc(doc(db,"workouts",id)); };

        // Gr√°fica Simple
        let chartInstance;
        function updateChart(logs) {
            const ctx = document.getElementById('chart').getContext('2d');
            const data = [...logs].reverse();
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(l => new Date(l.date).getDate()),
                    datasets: [{ label:'RPE', data: data.map(l=>l.rpe), borderColor:'#0a84ff', tension:0.3 }]
                },
                options: { plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}} }
            });
        }

        window.switchTab = (t) => {
            document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
            document.getElementById('p-'+t).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        window.addEventListener('load', initApp);
    </script>
</head>
<body>

    <div id="p-dash" class="page">
        
        <div class="week-container">
            <div>
                <div style="font-size:10px; color:#888;">SEMANA ACTUAL</div>
                <div id="week-text" style="font-weight:bold;">0/5 Sesiones</div>
            </div>
            <div id="week-dots"></div>
        </div>

        <div class="grid-stats">
            <div class="stat-box">
                <div class="stat-value" id="lvl-val">-</div>
                <div class="stat-label">Nivel</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" style="color:var(--accent)" id="rm-val">-</div>
                <div class="stat-label">1RM Est.</div>
            </div>
        </div>

        <h2 id="global-title" style="margin:10px 0;">Cargando...</h2>

        <div id="panel-weekend" class="card trekking-mode section-dynamic">
            <h3 style="margin:0;">üèîÔ∏è Modo Monta√±a</h3>
            <p>Hidrataci√≥n sugerida: <b id="trek-water">--</b></p>
            <div style="font-size:12px; margin-top:5px; border-top:1px solid var(--warning); padding-top:5px;">
                ü•§ <b>Isot√≥nico:</b> Agua + Lim√≥n + Sal + Miel.
            </div>
        </div>

        <div id="panel-weekday" class="card section-dynamic">
            <h3 style="margin:0;" id="gym-instruction">Entrenamiento</h3>
            <div style="display:flex; justify-content:space-between; margin-top:15px; align-items:center;">
                <span id="timer-val" style="font-size:24px; font-family:monospace; color:var(--primary);">0:00</span>
                <div style="display:flex; gap:5px;">
                    <button onclick="startTimer(60)" style="background:#333; color:#fff; border:none; padding:5px 10px; border-radius:5px;">1'</button>
                    <button onclick="startTimer(90)" style="background:#333; color:#fff; border:none; padding:5px 10px; border-radius:5px;">1.5'</button>
                </div>
            </div>
        </div>

        <div class="card" style="border: 1px solid var(--primary);">
            <div style="font-size:10px; color:#888; text-transform:uppercase; margin-bottom:5px;">Registrar Actividad</div>
            <input type="number" id="input-weight" step="0.1" placeholder="Peso (kg)">
            <select id="input-rpe">
                <option value="">Nivel de Esfuerzo (RPE)</option>
                <option value="6">6 - C√≥modo</option>
                <option value="7">7 - √ìptimo</option>
                <option value="8">8 - Duro</option>
                <option value="9">9 - M√°ximo</option>
            </select>
            <button id="btn-save" class="btn-main" onclick="saveSession()">REGISTRAR SESI√ìN</button>
        </div>

        <div class="card">
            <div class="checklist-item" id="c1" onclick="toggleCheck('c1')"><div class="cb"></div>Creatina</div>
            <div class="checklist-item" id="c2" onclick="toggleCheck('c2')"><div class="cb"></div>+7h Sue√±o</div>
            <div class="checklist-item" id="c3" onclick="toggleCheck('c3')"><div class="cb"></div>Sol / Naturaleza</div>
        </div>

    </div>

    <div id="p-stats" class="page hidden">
        <h1>An√°lisis</h1>
        <div class="card"><canvas id="chart" height="150"></canvas></div>
        <div class="card" id="history-list"></div>
    </div>

    <nav class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('dash')">DASHBOARD</button>
        <button class="tab-btn" onclick="switchTab('stats')">AN√ÅLISIS</button>
    </nav>

</body>
</html>
