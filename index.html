<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioHacker v12 Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, collection, query, orderBy, limit, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1xdMdcbHXgGAL008bdmq22SNgLVcC9jM",
            authDomain: "appweb-entrenamiento.firebaseapp.com",
            projectId: "appweb-entrenamiento",
            storageBucket: "appweb-entrenamiento.firebasestorage.app",
            messagingSenderId: "199318318696",
            appId: "1:199318318696:web:04c592f117296e375215dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- BASE DE DATOS MEJORADA (Descripciones + Videos) ---
        const EXERCISES = {
            pushups: { 
                name: "Flexiones", 
                rest: 60, 
                img: "https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?q=80&w=400&auto=format&fit=crop",
                desc: "Mant√©n el cuerpo recto como una tabla. Baja hasta que el pecho casi toque el suelo y sube explosivamente. Codos a 45 grados.",
                video: "https://www.youtube.com/results?search_query=tecnica+flexiones+correcta"
            },
            squats: { 
                name: "Sentadillas", 
                rest: 90, 
                img: "https://images.unsplash.com/photo-1574680096145-d05b474e2155?q=80&w=400&auto=format&fit=crop",
                desc: "Pies ancho de hombros. Baja cadera atr√°s y abajo rompiendo el paralelo (rodilla). Mant√©n pecho alto y espalda neutra.",
                video: "https://www.youtube.com/results?search_query=tecnica+sentadilla+air+squat"
            },
            lunges: { 
                name: "Zancadas", 
                rest: 60, 
                img: "https://images.unsplash.com/photo-1434608519344-49d77a699ded?q=80&w=400&auto=format&fit=crop",
                desc: "Da un paso largo. Baja la rodilla trasera casi al suelo. Ambas rodillas a 90 grados. Empuja con el tal√≥n delantero para volver.",
                video: "https://www.youtube.com/results?search_query=tecnica+zancadas"
            },
            plank: { 
                name: "Plancha Abd.", 
                rest: 45, 
                img: "https://plus.unsplash.com/premium_photo-1672046218038-f86a978f85f3?q=80&w=400&auto=format&fit=crop",
                desc: "Apoya antebrazos. Cuerpo recto. Aprieta gl√∫teos y abdomen fuertemente. No dejes caer la cadera.",
                video: "https://www.youtube.com/results?search_query=tecnica+plancha+abdominal"
            },
            burpees: { 
                name: "Burpees", 
                rest: 90, 
                img: "https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?q=80&w=400&auto=format&fit=crop", 
                desc: "Sentadilla -> Manos al suelo -> Salto atr√°s -> Flexi√≥n (pecho al suelo) -> Salto adelante -> Salto vertical con palmada.",
                video: "https://www.youtube.com/results?search_query=como+hacer+burpees"
            },
            row: { 
                name: "Remo / Dominada", 
                rest: 90, 
                img: "https://images.unsplash.com/photo-1598289431512-b97b0917affc?q=80&w=400&auto=format&fit=crop",
                desc: "Si tienes barra: Dominadas estrictas. Si no: Remo en mesa o con banda el√°stica. Retrae esc√°pulas al tirar.",
                video: "https://www.youtube.com/results?search_query=australian+pull+ups+home"
            }
        };

        const SCHEDULE = {
            1: { type: "Torso", keys: ["pushups", "row", "plank"] },
            2: { type: "Aer√≥bico", keys: [] },
            3: { type: "Pierna", keys: ["squats", "lunges", "plank"] },
            4: { type: "Aer√≥bico", keys: [] },
            5: { type: "Full Body", keys: ["burpees", "squats", "pushups"] },
            6: { type: "Trekking", keys: [] },
            0: { type: "Trekking", keys: [] }
        };

        // --- ESTILOS ---
        const styles = `
            :root { --primary: #0a84ff; --bg: #000; --card: #1c1c1e; --text: #fff; --accent: #32d74b; --warning: #ffd60a; }
            body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 100px; }
            
            .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
            .global-timer { font-family: monospace; font-size: 20px; font-weight: 700; color: #444; background: #111; padding: 5px 12px; border-radius: 8px; border: 1px solid #222; transition: all 0.3s; }
            .global-timer.active { color: var(--primary); border-color: var(--primary); box-shadow: 0 0 15px rgba(10,132,255,0.2); }

            /* Ejercicios */
            .ex-card { display: flex; align-items: center; background: #1c1c1e; margin-bottom: 12px; border-radius: 12px; overflow: hidden; padding-right: 15px; border: 1px solid #333; position: relative; }
            .ex-img { width: 85px; height: 85px; object-fit: cover; margin-right: 15px; cursor: pointer; }
            .ex-hint { position: absolute; bottom: 5px; left: 5px; font-size: 8px; background: rgba(0,0,0,0.7); padding: 2px 4px; border-radius: 4px; pointer-events: none; }
            .ex-info { flex: 1; }
            .ex-name { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
            .ex-meta { font-size: 13px; color: #888; display: flex; gap: 10px; }
            .tag-rest { color: var(--warning); font-weight: 600; }
            
            /* Start Btn */
            .sticky-action { position: fixed; bottom: 85px; left: 15px; right: 15px; z-index: 90; }
            .btn-start { width: 100%; background: var(--accent); color: #000; font-weight: 800; padding: 16px; border-radius: 15px; border: none; font-size: 18px; box-shadow: 0 4px 15px rgba(50, 215, 75, 0.3); cursor: pointer; }
            
            /* Active Panel & Finish */
            .active-panel { background: #111; border: 1px solid var(--primary); padding: 15px; border-radius: 15px; margin-bottom: 20px; display: none; }
            .active-panel.visible { display: block; animation: fadeIn 0.5s; }
            .rest-display { font-size: 36px; font-family: monospace; text-align: center; color: #fff; margin: 10px 0; }
            .rest-controls { display: flex; gap: 5px; justify-content: center; }
            .rest-controls button { background: #333; color: white; border: none; padding: 10px; border-radius: 8px; flex: 1; }

            .finish-card { display: none; margin-top: 30px; background: #1c1c1e; padding: 20px; border-radius: 20px; border: 1px solid #333; }
            .finish-card.visible { display: block; }
            input, select { width: 100%; padding: 14px; background: #000; border: 1px solid #444; color: #fff; border-radius: 10px; margin-top: 10px; box-sizing: border-box; font-size: 16px; }
            .btn-save { width: 100%; background: var(--primary); color: white; padding: 16px; border: none; border-radius: 12px; font-weight: bold; margin-top: 15px; font-size: 16px; }
            .btn-save.update { background: #ff9f0a; }

            /* MODAL INFO */
            .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
            .modal-content { background: #1c1c1e; width: 85%; max-width: 400px; padding: 25px; border-radius: 20px; border: 1px solid #444; text-align: center; position: relative; }
            .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; color: #888; background: none; border: none; cursor: pointer; }
            .btn-video { display: inline-block; background: #ff0000; color: white; text-decoration: none; padding: 10px 20px; border-radius: 20px; margin-top: 15px; font-weight: bold; font-size: 14px; }

            /* Tab Bar */
            .hidden { display: none !important; }
            .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(20,20,20,0.95); display: flex; padding: 15px; border-top: 1px solid #333; z-index: 100; }
            .tab-btn { flex: 1; background: none; border: none; color: #666; font-weight: 700; font-size: 11px; }
            .tab-btn.active { color: var(--primary); }
            
            @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        `;
        const styleSheet = document.createElement("style"); styleSheet.innerText = styles; document.head.appendChild(styleSheet);

        // --- L√ìGICA ---
        let userLevel = 1; let weight = 72;
        let todayRoutine = {};
        let currentReps = 10;
        let globalSeconds = 0; let globalInterval = null;
        let restInterval = null;
        let editingId = null; // Para saber si estamos editando

        window.initApp = async () => {
            const dayIdx = new Date().getDay();
            todayRoutine = SCHEDULE[dayIdx];
            
            onSnapshot(doc(db, "userStats", "global"), (d) => {
                if(d.exists()) {
                    const data = d.data();
                    userLevel = data.level || 1; weight = data.weight || 72;
                    currentReps = userLevel === 1 ? 10 : (userLevel === 2 ? 12 : 15);
                    renderSession();
                }
            });

            onSnapshot(query(collection(db, "workouts"), orderBy("date", "desc"), limit(10)), (snap) => {
                const logs = snap.docs.map(d => ({id:d.id, ...d.data()}));
                renderHistory(logs);
                updateChart(logs);
            });
        };

        function renderSession() {
            document.getElementById('today-title').innerText = todayRoutine.type;
            const container = document.getElementById('session-content');
            
            if (todayRoutine.type === "Trekking" || todayRoutine.type === "Aer√≥bico") {
                document.getElementById('start-btn-container').style.display = 'none';
                const msg = todayRoutine.type === "Trekking" ? "üèîÔ∏è D√≠a de Monta√±a" : "üèÉ Aer√≥bico / Zona 2";
                const sub = todayRoutine.type === "Trekking" ? `Hidrataci√≥n: ${(weight*0.04).toFixed(1)}L` : "45-60 Minutos ritmo constante";
                container.innerHTML = `<div class="ex-card" style="padding:25px; display:block; text-align:center; border-color:var(--warning); color:var(--warning);"><h3>${msg}</h3><p>${sub}</p></div>`;
            } else {
                let html = "";
                todayRoutine.keys.forEach(key => {
                    const ex = EXERCISES[key];
                    html += `
                        <div class="ex-card">
                            <img src="${ex.img}" class="ex-img" onclick="showInfo('${key}')">
                            <div class="ex-hint">‚ÑπÔ∏è Toca foto</div>
                            <div class="ex-info">
                                <div class="ex-name">${ex.name}</div>
                                <div class="ex-meta">
                                    <span>3 Series x ${currentReps} Reps</span>
                                    <span class="tag-rest">‚è≥ ${ex.rest}s</span>
                                </div>
                            </div>
                        </div>`;
                });
                container.innerHTML = html;
                document.getElementById('start-btn-container').style.display = 'block';
            }
        }

        // --- MODAL INFO ---
        window.showInfo = (key) => {
            const ex = EXERCISES[key];
            document.getElementById('m-title').innerText = ex.name;
            document.getElementById('m-desc').innerText = ex.desc;
            document.getElementById('m-video').href = ex.video;
            document.getElementById('info-modal').style.display = 'flex';
        };
        window.closeModal = () => document.getElementById('info-modal').style.display = 'none';

        // --- LOGICA TIMER ---
        window.startWorkout = () => {
            document.getElementById('start-btn-container').style.display = 'none';
            document.getElementById('panel-active').classList.add('visible');
            document.getElementById('finish-section').classList.add('visible');
            document.getElementById('global-timer-ui').classList.add('active');

            if(globalInterval) clearInterval(globalInterval);
            globalSeconds = 0;
            globalInterval = setInterval(() => {
                globalSeconds++;
                const m = Math.floor(globalSeconds/60);
                const s = globalSeconds%60;
                document.getElementById('global-timer-ui').innerText = `${m}:${s.toString().padStart(2,'0')}`;
            }, 1000);
            
            window.scrollTo({ top: 100, behavior: 'smooth' });
        };

        window.startRest = (sec) => {
            if(restInterval) clearInterval(restInterval);
            let left = sec;
            const display = document.getElementById('rest-display');
            display.style.color = "#fff";
            
            restInterval = setInterval(() => {
                left--;
                const m = Math.floor(left/60); const s = left%60;
                display.innerText = `${m}:${s.toString().padStart(2,'0')}`;
                if(left<=0) {
                    clearInterval(restInterval);
                    display.style.color = "var(--accent)";
                    navigator.vibrate([200, 100, 200]);
                }
            }, 1000);
        };

        // --- GUARDAR / EDITAR ---
        window.saveSession = async () => {
            const rpe = document.getElementById('inp-rpe').value;
            const w = document.getElementById('inp-weight').value;
            if(!rpe || !w) return alert("Rellena todos los datos");

            const btn = document.getElementById('btn-finish');
            const originalText = btn.innerText;
            btn.innerText = "Procesando...";

            // IA Coach Logic
            let newLvl = userLevel;
            if(parseInt(rpe) <= 6) newLvl++;
            else if(parseInt(rpe) >= 9 && userLevel > 1) newLvl--;

            const data = {
                date: new Date().toISOString(),
                type: todayRoutine.type,
                rpe: parseInt(rpe),
                weight: parseFloat(w),
                duration: Math.ceil(globalSeconds/60),
                level: newLvl // Guardamos nivel para la gr√°fica
            };

            if(editingId) {
                // MODO EDICI√ìN
                await updateDoc(doc(db, "workouts", editingId), data);
                alert("Entreno actualizado");
                editingId = null;
                btn.classList.remove('update');
                btn.innerText = "GUARDAR Y TERMINAR";
            } else {
                // MODO NUEVO
                await addDoc(collection(db, "workouts"), data);
                await setDoc(doc(db, "userStats", "global"), { level: newLvl, weight: parseFloat(w) }, { merge: true });
                alert("¬°Guardado! Buen trabajo.");
            }
            
            location.reload();
        };

        // --- HISTORIAL Y EDICI√ìN ---
        function renderHistory(logs) {
            document.getElementById('hist-list').innerHTML = logs.map(l => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #333; font-size:13px;">
                    <div>
                        <b style="color:white">${l.type}</b>
                        <br><span style="color:#666">${new Date(l.date).toLocaleDateString()} ¬∑ Lvl ${l.level||1} ¬∑ RPE ${l.rpe}</span>
                    </div>
                    <div>
                        <button onclick='editLog("${l.id}", ${l.weight}, ${l.rpe})' style="background:none; border:none; margin-right:10px; font-size:16px;">‚úèÔ∏è</button>
                        <button onclick="deleteLog('${l.id}')" style="color:#ff453a; background:none; border:none; font-size:16px;">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        window.editLog = (id, w, rpe) => {
            switchTab('train');
            // Preparar UI para edici√≥n
            editingId = id;
            document.getElementById('start-btn-container').style.display = 'none';
            document.getElementById('finish-section').classList.add('visible');
            document.getElementById('inp-weight').value = w;
            document.getElementById('inp-rpe').value = rpe;
            
            const btn = document.getElementById('btn-finish');
            btn.innerText = "ACTUALIZAR REGISTRO";
            btn.classList.add('update');
            
            document.getElementById('session-content').innerHTML = `<div style="text-align:center; padding:20px; color:#ff9f0a;">‚úèÔ∏è Editando registro hist√≥rico...</div>`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.deleteLog = async(id) => { if(confirm("¬øBorrar?")) await deleteDoc(doc(db,"workouts",id)); };

        // --- GR√ÅFICA PROGRESI√ìN REAL (NIVEL) ---
        let chartInstance;
        function updateChart(logs) {
            const ctx = document.getElementById('chart').getContext('2d');
            const data = [...logs].reverse(); // Orden cronol√≥gico
            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(l => new Date(l.date).getDate() + '/' + (new Date(l.date).getMonth()+1)),
                    datasets: [{ 
                        label: 'Nivel de Fuerza', 
                        data: data.map(l => l.level || 1), // Graficamos NIVEL, no RPE
                        borderColor: '#32d74b', // Verde progreso
                        backgroundColor: 'rgba(50, 215, 75, 0.1)',
                        fill: true,
                        tension: 0.3,
                        stepped: true // Escalones porque el nivel son saltos enteros
                    }]
                },
                options: { 
                    plugins:{ legend:{ display: true, labels:{color:'white'} } }, 
                    scales:{ 
                        x:{ display:true, grid:{display:false} }, 
                        y:{ display:true, grid:{color:'#333'}, min: 0, ticks:{stepSize:1} } 
                    } 
                }
            });
        }

        window.switchTab = (t) => {
            document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
            document.getElementById('p-'+t).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        window.addEventListener('load', initApp);
    </script>
</head>
<body>

    <div id="info-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">√ó</button>
            <h2 id="m-title" style="margin-bottom:10px;">Ejercicio</h2>
            <p id="m-desc" style="color:#ccc; font-size:14px; line-height:1.5;">Descripci√≥n...</p>
            <a id="m-video" href="#" target="_blank" class="btn-video">üì∫ Ver Tutorial en YouTube</a>
        </div>
    </div>

    <div id="p-train" class="page">
        <div class="top-bar">
            <div>
                <div style="font-size:10px; color:#888;">HOY TOCA</div>
                <h2 id="today-title">Cargando...</h2>
            </div>
            <div id="global-timer-ui" class="global-timer">00:00</div>
        </div>

        <div id="panel-active" class="active-panel">
            <div style="text-align:center; font-size:10px; color:#888; text-transform:uppercase;">Descanso</div>
            <div id="rest-display" class="rest-display">0:00</div>
            <div class="rest-controls">
                <button onclick="startRest(30)">30s</button>
                <button onclick="startRest(60)">60s</button>
                <button onclick="startRest(90)">90s</button>
                <button onclick="startRest(120)">2m</button>
            </div>
        </div>

        <div id="session-content" style="padding-bottom: 80px;"></div>

        <div id="start-btn-container" class="sticky-action">
            <button class="btn-start" onclick="startWorkout()">‚ñ∂ COMENZAR ENTRENAMIENTO</button>
        </div>

        <div id="finish-section" class="finish-card">
            <h3 style="margin-bottom:10px;">Registro de Sesi√≥n</h3>
            <input type="number" id="inp-weight" placeholder="Peso Actual (kg)">
            <select id="inp-rpe">
                <option value="">Nivel de Esfuerzo (RPE)</option>
                <option value="6">6 - F√°cil (Sube Nivel)</option>
                <option value="7">7 - Adecuado</option>
                <option value="8">8 - Duro</option>
                <option value="9">9 - Muy Duro (Baja Nivel)</option>
            </select>
            <button id="btn-finish" class="btn-save" onclick="saveSession()">GUARDAR Y TERMINAR</button>
        </div>
    </div>

    <div id="p-anl" class="page hidden">
        <h1>Mi Progreso</h1>
        <div class="card"><canvas id="chart" height="150"></canvas></div>
        <div class="card" id="hist-list"></div>
    </div>

    <nav class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('train')">ENTRENO</button>
        <button class="tab-btn" onclick="switchTab('anl')">DATOS</button>
    </nav>

</body>
</html>
